---
interface Props {
  allCases: any[];
  currentSlug: string;
  baseUrl?: string;
}

const {
  allCases,
  currentSlug,
  baseUrl = '/cases',
} = Astro.props;

const casesByScenario = allCases.reduce(
  (acc, c) => {
    const key = c.data.scenarioId;
    if (!acc[key]) acc[key] = [];
    acc[key].push(c);
    return acc;
  },
  {} as Record<string, typeof allCases>,
);

const osGroups = allCases.reduce(
  (acc, c) => {
    const key = c.data.os;
    if (!acc[key]) acc[key] = [];
    acc[key].push(c);
    return acc;
  },
  {} as Record<string, typeof allCases>,
);

const browserGroups = allCases.reduce(
  (acc, c) => {
    const key = c.data.browser;
    if (!acc[key]) acc[key] = [];
    acc[key].push(c);
    return acc;
  },
  {} as Record<string, typeof allCases>,
);

const deviceGroups = allCases.reduce(
  (acc, c) => {
    const key = c.data.device;
    if (!acc[key]) acc[key] = [];
    acc[key].push(c);
    return acc;
  },
  {} as Record<string, typeof allCases>,
);
---

<aside
  aria-label="Cases"
  class="sticky top-0 h-screen overflow-y-auto w-full border-r border-border-light bg-bg-muted p-0 text-sm flex-shrink-0"
>
  <nav aria-label="Case list" class="py-2">
    <ul class="list-none p-0 m-0">
      {Object.entries(casesByScenario).map(([scenarioId, scenarioCases]) => (
        <li class="mb-2">
          <div class="text-xs font-semibold mb-1 ml-3 text-text-secondary uppercase tracking-wide">
            {scenarioId}
          </div>
          <ul class="list-none p-0 m-0">
            {scenarioCases.map((c) => {
              const isActive = c.slug === currentSlug;
              return (
                <li class="m-0">
                  <a
                    href={`/cases/${c.slug}`}
                    title={`${c.data.id}: ${c.data.caseTitle} (${c.data.browser})`}
                    data-active={isActive}
                    class:list={[
                      'block pl-6 pr-3 py-1.5 no-underline text-sm transition-colors',
                      isActive
                        ? 'bg-accent-primary text-bg-surface border-l-[3px] border-l-[#0069c2] hover:text-bg-surface'
                        : 'bg-transparent text-text-primary border-l-[3px] border-l-transparent hover:bg-bg-surface',
                    ]}
                  >
                    <div class="truncate">{c.data.caseTitle}</div>
                    <div class:list={[
                      'text-xs mt-0.5 truncate',
                      isActive ? 'text-bg-surface/80' : 'text-text-secondary'
                    ]}>
                      {c.data.id} Â· {c.data.browser}
                    </div>
                  </a>
                </li>
              );
            })}
          </ul>
        </li>
      ))}
    </ul>
  </nav>
</aside>

<script>
  // Scroll to active item on page load
  function scrollToActiveItem() {
    const sidebar = document.querySelector('aside[aria-label="Cases"]');
    const activeLink = sidebar?.querySelector('a[data-active="true"]');
    if (activeLink && sidebar) {
      // Calculate position relative to sidebar container
      const sidebarRect = sidebar.getBoundingClientRect();
      const linkRect = activeLink.getBoundingClientRect();
      const scrollTop = sidebar.scrollTop;
      const linkOffsetTop = linkRect.top - sidebarRect.top + scrollTop;
      const centerOffset = sidebar.clientHeight / 2 - linkRect.height / 2;
      
      sidebar.scrollTo({
        top: linkOffsetTop - centerOffset,
        behavior: 'smooth'
      });
    }
  }
  
  // Try multiple times to handle async rendering
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(scrollToActiveItem, 100);
    });
  } else {
    setTimeout(scrollToActiveItem, 100);
  }
</script>

