---
interface Props {
  allScenarios: any[];
  allCases: any[];
  currentScenarioId: string;
  baseUrl?: string;
}

const {
  allScenarios,
  allCases,
  currentScenarioId,
  baseUrl = '/scenarios',
} = Astro.props;

// Group scenarios by category for sidebar
const scenariosByCategory = allScenarios.reduce(
  (acc, s) => {
    const category = s.data.category || 'other';
    if (!acc[category]) acc[category] = [];
    acc[category].push(s);
    return acc;
  },
  {} as Record<string, typeof allScenarios>,
);

// Sort scenarios within each category
Object.keys(scenariosByCategory).forEach((category) => {
  scenariosByCategory[category].sort((a, b) => a.data.id.localeCompare(b.data.id));
});
---

<aside
  aria-label="Scenarios"
  class="sticky top-0 h-screen overflow-y-auto w-full border-r border-border-light bg-bg-muted p-0 text-sm flex-shrink-0"
>
  <nav aria-label="Scenario list" class="py-2">
    <ul class="list-none p-0 m-0">
      {Object.entries(scenariosByCategory).map(([category, categoryScenarios]) => (
        <li class="mb-2">
          <div class="text-xs font-semibold mb-1 ml-3 text-text-secondary uppercase tracking-wide">
            {category}
          </div>
          <ul class="list-none p-0 m-0">
            {categoryScenarios.map((s) => {
              const scenarioCases = allCases.filter((c) => c.data.scenarioId === s.data.id);
              const isActive = s.data.id === currentScenarioId;
              return (
                <li class="m-0">
                  <a
                    href={`/scenarios/${encodeURIComponent(s.data.id)}`}
                    title={s.data.title}
                    data-active={isActive}
                    class:list={[
                      'block pl-6 pr-3 py-1.5 no-underline text-sm transition-colors',
                      isActive
                        ? 'bg-accent-primary text-bg-surface border-l-[3px] border-l-[#0069c2] hover:text-bg-surface'
                        : 'bg-transparent text-text-primary border-l-[3px] border-l-transparent hover:bg-bg-surface',
                    ]}
                  >
                    <div class="truncate">{s.data.title}</div>
                    <div class:list={[
                      'text-xs mt-0.5',
                      isActive ? 'text-bg-surface/80' : 'text-text-secondary'
                    ]}>
                      {scenarioCases.length} case{scenarioCases.length === 1 ? '' : 's'}
                    </div>
                  </a>
                </li>
              );
            })}
          </ul>
        </li>
      ))}
    </ul>
  </nav>
</aside>

<script>
  // Scroll to active item on page load
  function scrollToActiveItem() {
    const sidebar = document.querySelector('aside[aria-label="Scenarios"]');
    const activeLink = sidebar?.querySelector('a[data-active="true"]');
    if (activeLink && sidebar) {
      // Calculate position relative to sidebar container
      const sidebarRect = sidebar.getBoundingClientRect();
      const linkRect = activeLink.getBoundingClientRect();
      const scrollTop = sidebar.scrollTop;
      const linkOffsetTop = linkRect.top - sidebarRect.top + scrollTop;
      const centerOffset = sidebar.clientHeight / 2 - linkRect.height / 2;
      
      sidebar.scrollTo({
        top: linkOffsetTop - centerOffset,
        behavior: 'smooth'
      });
    }
  }
  
  // Try multiple times to handle async rendering
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(scrollToActiveItem, 100);
    });
  } else {
    setTimeout(scrollToActiveItem, 100);
  }
</script>

