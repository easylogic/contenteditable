---
import { getCollection, getEntry } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import { CasePlayground } from '../../components/CasePlayground';
import SiteNav from '../../components/SiteNav.astro';
import BaseHead from '../../components/BaseHead.astro';
import RelatedCases from '../../components/RelatedCases.astro';
import { CaseExport } from '../../components/CaseExport';
import { CaseVerification } from '../../components/CaseVerification';
import { DomChangeAnimation } from '../../components/DomChangeAnimation';
import CasesSidebar from '../../components/CasesSidebar.astro';
import EditOnGitHub from '../../components/EditOnGitHub.astro';
import Comments from '../../components/Comments.astro';
import { ResizableSidebar } from '../../components/ResizableSidebar';
import '../../styles/global.css';

export const getStaticPaths = (async () => {
  const cases = await getCollection('cases', ({ data }) => data.locale === 'en');
  return cases.map((entry) => ({
    params: { id: entry.slug },
  }));
}) satisfies GetStaticPaths;

const slug = Astro.params.id;

if (!slug) {
  throw new Error('Case slug is missing in route params.');
}

const entry = await getEntry('cases', slug);

if (!entry) {
  throw new Error(`Case entry for slug "${slug}" was not found.`);
}

const allCases = await getCollection('cases', ({ data }) => data.locale === 'en');
const allCasesAllLocales = await getCollection('cases'); // For sidebar - all locales

const sameScenarioCases = allCases.filter(
  (c) => c.data.scenarioId === entry.data.scenarioId,
);

// Build compatibility matrix for this scenario
const scenarioBrowsers = Array.from(new Set(sameScenarioCases.map((c) => c.data.browser))).sort();
const scenarioOS = Array.from(new Set(sameScenarioCases.map((c) => c.data.os))).sort();

const scenarioMatrix = scenarioBrowsers.map((browser) => {
  const browserCases = sameScenarioCases.filter((c) => c.data.browser === browser);
  return {
    browser,
    osCoverage: scenarioOS.map((os) => {
      const osCases = browserCases.filter((c) => c.data.os === os);
      return {
        os,
        cases: osCases,
        hasCase: osCases.length > 0,
        versions: osCases.map((c) => ({
          osVersion: c.data.osVersion || 'Any',
          browserVersion: c.data.browserVersion || 'Any',
          caseId: c.data.id,
          slug: c.slug,
          status: c.data.status,
          isCurrent: c.slug === slug,
        })),
      };
    }),
  };
});

const { Content } = await entry.render();
---

<html lang="en">
  <head>
    <BaseHead title={entry.data.caseTitle} />
  </head>
  <body>
    <SiteNav />
    <main class="flex max-w-full m-0 p-0">
      <ResizableSidebar client:load storageKey="cases-sidebar-width">
      <CasesSidebar
        allCases={allCasesAllLocales}
        currentSlug={slug}
        currentCaseId={entry.data.id}
        locale="en"
      />
      </ResizableSidebar>

        <section class="flex-1 max-w-[1120px] mx-auto py-7 px-5 pb-10 w-full">
          <header class="mb-6">
            <p class="m-0 mb-2 text-xs text-text-muted">
              Case {entry.data.id} · Scenario{' '}
              <a
                href={`/scenarios/${encodeURIComponent(entry.data.scenarioId)}`}
                class="text-inherit underline"
              >
                {entry.data.scenarioId}
              </a>
            </p>
            <h1 class="text-[1.85rem] leading-[1.2] m-0 mb-3">
              {entry.data.caseTitle}
            </h1>

            <div class="flex flex-wrap gap-1.5 gap-x-3 text-xs text-text-secondary">
              <span>
                OS: {entry.data.os}
                {entry.data.osVersion && ` ${entry.data.osVersion}`}
              </span>
              <span>
                Device: {entry.data.device}
                {entry.data.deviceVersion && ` ${entry.data.deviceVersion}`}
              </span>
              <span>
                Browser: {entry.data.browser}
                {entry.data.browserVersion && ` ${entry.data.browserVersion}`}
              </span>
              <span>Keyboard: {entry.data.keyboard}</span>
              <span>Status: {entry.data.status}</span>
            </div>

            {entry.data.tags.length > 0 && (
              <div class="mt-1.5 text-xs">
                {entry.data.tags.map((tag) => (
                  <span class="inline-flex items-center rounded-full border border-border-light px-1.5 py-0.5 mr-1 bg-bg-muted">
                    {tag}
                  </span>
                ))}
              </div>
            )}

            <div class="mt-3 flex items-center gap-3 flex-wrap">
              <CaseExport
                client:load
                caseData={{
                  id: entry.data.id,
                  caseTitle: entry.data.caseTitle,
                  description: entry.data.description,
                  os: entry.data.os,
                  osVersion: entry.data.osVersion,
                  device: entry.data.device,
                  deviceVersion: entry.data.deviceVersion,
                  browser: entry.data.browser,
                  browserVersion: entry.data.browserVersion,
                  keyboard: entry.data.keyboard,
                  reproductionSteps: entry.data.reproductionSteps,
                  initialHtml: entry.data.initialHtml,
                  scenarioId: entry.data.scenarioId,
                  tags: entry.data.tags,
                  status: entry.data.status,
                }}
              />
              <EditOnGitHub filePath={`src/content/cases/${entry.slug}.md`} />
            </div>
          </header>

          <article class="rounded-xl border border-border-light bg-bg-surface p-4 px-4.5 text-sm leading-relaxed">
            <div class="case-markdown">
              <Content />
            </div>
          </article>

          {entry.data.domSteps && entry.data.domSteps.length > 0 && (
            <DomChangeAnimation
              client:load
              steps={entry.data.domSteps}
              autoPlay={false}
              interval={2500}
            />
          )}

          <CaseVerification
            client:load
            caseId={entry.data.id}
            caseTitle={entry.data.caseTitle}
            os={entry.data.os}
            browser={entry.data.browser}
            status={entry.data.status}
          />

          {sameScenarioCases.length > 1 && (
            <>
              <section
                aria-label="Browser compatibility matrix"
                class="mt-4 rounded-xl border border-border-light bg-bg-surface p-3.5 px-4 text-sm"
              >
                <h2 class="text-sm m-0 mb-1.5">
                  Browser compatibility matrix
                </h2>
                <p class="m-0 mb-2.5 text-text-secondary text-xs">
                  This matrix shows which browser and OS combinations have documented cases for this
                  scenario. The current case is highlighted. Click on a cell to view other cases.
                </p>
                <div class="overflow-x-auto">
                  <table class="w-full border-collapse text-xs">
                    <thead>
                      <tr>
                        <th class="text-left px-2 py-1.5 border-b-2 border-border-light bg-bg-muted sticky left-0 z-[1]">
                          Browser
                        </th>
                        {scenarioOS.map((os) => (
                          <th class="text-center px-2 py-1.5 border-b-2 border-border-light bg-bg-muted font-semibold">
                            {os}
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {scenarioMatrix.map((row) => (
                        <tr>
                          <td class="px-2 py-1.5 border-b border-border-light bg-bg-muted font-semibold sticky left-0 z-[1]">
                            {row.browser}
                          </td>
                          {row.osCoverage.map((cell) => (
                            <td
                              class:list={[
                                'px-1.5 py-1 border-b border-border-light text-center min-w-[80px]',
                                cell.versions.some((v) => v.isCurrent) ? 'bg-gray-900/6 dark:bg-gray-100/6' : 'bg-transparent',
                              ]}
                            >
                              {cell.hasCase ? (
                                <div class="flex flex-col gap-0.5 items-center">
                                  {cell.versions.map((v) => (
                                    <a
                                      href={`/cases/${v.slug}`}
                                      class:list={[
                                        'inline-block px-1.5 py-0.5 rounded no-underline text-[0.7rem] font-medium text-white',
                                        v.isCurrent
                                          ? 'bg-text-primary border-2 border-text-primary'
                                          : v.status === 'confirmed'
                                            ? 'bg-status-confirmed border-none'
                                            : 'bg-status-draft border-none',
                                      ]}
                                      title={`${v.caseId}: ${row.browser} ${v.browserVersion} on ${cell.os} ${v.osVersion}`}
                                    >
                                      {v.caseId}
                                      {v.isCurrent && ' (current)'}
                                    </a>
                                  ))}
                                  <div class="text-[0.65rem] text-text-muted mt-0.5">
                                    {cell.versions
                                      .map((v) => `${v.browserVersion || 'Any'}`)
                                      .join(', ')}
                                  </div>
                                </div>
                              ) : (
                                <span class="text-text-faint">—</span>
                              )}
                            </td>
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <div class="mt-2.5 pt-2.5 border-t border-border-light text-xs text-text-muted">
                  <div class="flex gap-4 items-center flex-wrap">
                    <div class="flex items-center gap-1.5">
                      <span class="inline-block w-3 h-3 rounded bg-text-primary"></span>
                      <span>Current case</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                      <span class="inline-block w-3 h-3 rounded bg-status-confirmed"></span>
                      <span>Confirmed</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                      <span class="inline-block w-3 h-3 rounded bg-status-draft"></span>
                      <span>Draft</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                      <span class="text-text-faint">—</span>
                      <span>No case documented</span>
                    </div>
                  </div>
                </div>
              </section>

              <section
                aria-label="Variants table"
                class="mt-4 rounded-xl border border-border-light bg-bg-surface p-3.5 px-4 text-sm"
              >
                <h2 class="text-sm m-0 mb-1.5">
                  All variants (detailed table)
                </h2>
                <p class="m-0 mb-2.5 text-text-secondary text-xs">
                  Complete list of all cases for this scenario with full environment details.
                </p>
                <div class="overflow-x-auto">
                  <table class="w-full border-collapse text-xs">
                    <thead>
                      <tr>
                        <th class="text-left px-1.5 py-1">Case</th>
                        <th class="text-left px-1.5 py-1">OS</th>
                        <th class="text-left px-1.5 py-1">Device</th>
                        <th class="text-left px-1.5 py-1">Browser</th>
                        <th class="text-left px-1.5 py-1">Keyboard</th>
                        <th class="text-left px-1.5 py-1">Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {sameScenarioCases.map((c) => (
                        <tr
                          class:list={[
                            c.slug === slug ? 'bg-gray-900/5 dark:bg-gray-100/5' : 'bg-transparent',
                          ]}
                        >
                          <td class="p-1 px-1.5">
                            <a
                              href={`/cases/${c.slug}`}
                              class="text-text-primary no-underline"
                            >
                              {c.data.id}
                            </a>
                          </td>
                          <td class="px-1.5 py-1">
                            {c.data.os}
                            {c.data.osVersion && ` ${c.data.osVersion}`}
                          </td>
                          <td class="px-1.5 py-1">
                            {c.data.device}
                            {c.data.deviceVersion && ` ${c.data.deviceVersion}`}
                          </td>
                          <td class="px-1.5 py-1">
                            {c.data.browser}
                            {c.data.browserVersion && ` ${c.data.browserVersion}`}
                          </td>
                          <td class="px-1.5 py-1">{c.data.keyboard}</td>
                          <td class="px-1.5 py-1">{c.data.status}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </section>
            </>
          )}

          <CasePlayground
            client:load
            id={entry.data.id}
            caseTitle={entry.data.caseTitle}
            os={entry.data.os}
            osVersion={entry.data.osVersion}
            device={entry.data.device}
            deviceVersion={entry.data.deviceVersion}
            browser={entry.data.browser}
            browserVersion={entry.data.browserVersion}
            keyboard={entry.data.keyboard}
          />

          <RelatedCases
            currentCase={{
              id: entry.data.id,
              slug: entry.slug,
              caseTitle: entry.data.caseTitle,
              os: entry.data.os,
              browser: entry.data.browser,
              tags: entry.data.tags,
              scenarioId: entry.data.scenarioId,
            }}
            allCases={allCases.map((c) => ({
              id: c.data.id,
              slug: c.slug,
              caseTitle: c.data.caseTitle,
              os: c.data.os,
              browser: c.data.browser,
              tags: c.data.tags,
              scenarioId: c.data.scenarioId,
            }))}
          />

          <Comments
            repo="easylogic/contenteditable"
            repoId=""
            category="Q&A"
            categoryId=""
            mapping={`pathname`}
            reactionsEnabled={true}
            inputPosition="bottom"
            theme="preferred_color_scheme"
            lang="en"
          />
        </section>
      </div>
    </main>
  </body>
</html>


