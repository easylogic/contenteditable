---
import DocLayout from '../../../components/docs/DocLayout.astro';
import DocSection from '../../../components/docs/DocSection.astro';
import DocAlert from '../../../components/docs/DocAlert.astro';
import DocInfoBox from '../../../components/docs/DocInfoBox.astro';
import EditorExample from '../../../components/EditorExample.astro';
import TableOfContents from '../../../components/TableOfContents.astro';
import '../../../styles/global.css';

// Define headings for TOC
const headings = [
  { depth: 2, slug: 'overview', text: 'Overview' },
  { depth: 2, slug: 'basic-behavior', text: 'Basic Behavior' },
  { depth: 2, slug: 'security-considerations', text: 'Security Considerations' },
  { depth: 2, slug: 'browser-specific-behavior', text: 'Browser-Specific Behavior' },
  { depth: 2, slug: 'ime-composition-inserthtml', text: 'IME Composition + insertHTML' },
  { depth: 2, slug: 'editor-specific-handling', text: 'Editor-Specific Handling' },
];
---

<DocLayout
  title="insertHTML"
  description="How insertHTML inputType inserts HTML content and varies across browsers."
  currentPath={Astro.url.pathname}
>
        <DocSection id="overview" title="Overview">
          <p class="m-0 mb-4">
            The <code class="bg-bg-muted px-1.5 py-0.5 rounded text-[0.85em]">insertHTML</code> inputType is triggered when HTML content is inserted programmatically (e.g., from paste operations or programmatic insertion). The browser parses the HTML string and inserts it as DOM nodes at the selection position.
          </p>
        </DocSection>

        <DocSection id="basic-behavior" title="Basic Behavior">
          <DocInfoBox title="Scenario 1: HTML string inserted at cursor">
            <div class="space-y-4">
              <div>
                <h4 class="text-sm font-semibold mb-2 text-text-primary">Before (Cursor position)</h4>
                <div class="bg-bg-surface border border-border-light rounded-md p-3 font-mono text-sm">
                  <div class="text-text-secondary">HTML:</div>
                  <div class="text-text-primary mt-1">&lt;p&gt;Hello<span class="bg-blue-200 dark:bg-blue-900/40 px-1 rounded">|</span>world&lt;/p&gt;</div>
                </div>
              </div>
              
              <div>
                <h4 class="text-sm font-semibold mb-2 text-text-primary">After insertHTML('&lt;strong&gt;bold&lt;/strong&gt;')</h4>
                <div class="bg-bg-surface border border-border-light rounded-md p-3 font-mono text-sm">
                  <div class="text-text-secondary">HTML:</div>
                  <div class="text-text-primary mt-1">&lt;p&gt;Hello<span class="bg-blue-200 dark:bg-blue-900/40 font-bold">&lt;strong&gt;bold&lt;/strong&gt;</span>world&lt;/p&gt;</div>
                  <div class="text-text-secondary mt-2 text-xs">HTML parsed and inserted as DOM nodes</div>
                </div>
              </div>
            </div>
          </DocInfoBox>

          <DocInfoBox title="Scenario 2: HTML replaces selected text" class="mt-6">
            <div class="space-y-4">
              <div>
                <h4 class="text-sm font-semibold mb-2 text-text-primary">Before (Text selected)</h4>
                <div class="bg-bg-surface border border-border-light rounded-md p-3 font-mono text-sm">
                  <div class="text-text-secondary">HTML:</div>
                  <div class="text-text-primary mt-1">&lt;p&gt;Hello <span class="bg-yellow-200 dark:bg-yellow-900/40">world</span> text&lt;/p&gt;</div>
                </div>
              </div>
              
              <div>
                <h4 class="text-sm font-semibold mb-2 text-text-primary">After insertHTML('&lt;em&gt;italic&lt;/em&gt;')</h4>
                <div class="bg-bg-surface border border-border-light rounded-md p-3 font-mono text-sm">
                  <div class="text-text-secondary">HTML:</div>
                  <div class="text-text-primary mt-1">&lt;p&gt;Hello <span class="bg-yellow-200 dark:bg-yellow-900/40 italic">&lt;em&gt;italic&lt;/em&gt;</span> text&lt;/p&gt;</div>
                  <div class="text-text-secondary mt-2 text-xs">Selected text replaced with parsed HTML</div>
                </div>
              </div>
            </div>
          </DocInfoBox>
        </DocSection>

        <DocSection id="security-considerations" title="Security Considerations">
          <DocAlert type="warning" title="⚠️ XSS Risk">
            <p class="m-0 mb-2 text-sm">
              <strong>Warning:</strong> Inserting arbitrary HTML can lead to XSS (Cross-Site Scripting) vulnerabilities. Always sanitize HTML content before insertion.
            </p>
            <p class="m-0 text-sm">
              Use libraries like <code class="bg-white/50 dark:bg-black/20 px-1.5 py-0.5 rounded text-[0.85em]">DOMPurify</code> to sanitize HTML before inserting it into contenteditable elements.
            </p>
          </DocAlert>
        </DocSection>

        <DocSection id="browser-specific-behavior" title="Browser-Specific Behavior">
          <DocInfoBox>
            <ul class="m-0 pl-6 text-sm text-text-secondary">
              <li class="mb-2">HTML parsing behavior may vary between browsers</li>
              <li class="mb-2">Some browsers may strip or modify certain HTML elements for security reasons</li>
              <li class="mb-2">Invalid HTML may be auto-corrected or ignored depending on the browser</li>
            </ul>
          </DocInfoBox>
        </DocSection>

        <DocSection id="ime-composition-inserthtml" title="IME Composition + insertHTML">
          <DocAlert type="error" title="⚠️ Critical Issue">
            <p class="m-0 mb-2 text-sm">
              During IME composition, inserting HTML (e.g., from paste operations) may cancel the active composition. The composition text may be lost or the HTML may be inserted in an unexpected location.
            </p>
            <p class="m-0 text-sm">
              When handling paste operations, check for active composition state before inserting HTML to avoid interrupting the user's input.
            </p>
          </DocAlert>
        </DocSection>

        <DocSection id="editor-specific-handling" title="Editor-Specific Handling">
          <p class="m-0 mb-4">
            Different editor frameworks handle HTML insertion differently, typically converting HTML to their internal model format. Here's how major editors implement insertHTML:
          </p>

          <EditorExample
            editor="slate"
            title="HTML Insertion"
            description="Slate parses HTML and converts it to Slate nodes:"
            code={`import { Editor, Transforms } from 'slate';
import { jsx } from 'slate-hyperscript';

element.addEventListener('beforeinput', (e) => {
  if (e.inputType === 'insertHTML' && e.dataTransfer) {
    e.preventDefault();
    
    // Parse HTML string to Slate nodes
    const htmlString = e.dataTransfer.getData('text/html');
    const fragment = new DOMParser().parseFromString(htmlString, 'text/html');
    
    // Convert DOM nodes to Slate nodes (using slate-hyperscript or custom parser)
    const nodes = Array.from(fragment.body.childNodes).map(node => {
      // Convert DOM node to Slate node structure
      // This is a simplified example - real implementation would be more complex
      return jsx('element', { type: 'paragraph' }, [{ text: node.textContent }]);
    });
    
    // Insert nodes at selection
    Transforms.insertNodes(editor, nodes);
  }
});`}
            features={[
              '<strong>HTML parsing:</strong> Parses HTML string into DOM, then converts to Slate nodes.',
              '<strong>Model conversion:</strong> Converts browser HTML structure to Slate\'s internal node model.',
              '<strong>Schema enforcement:</strong> Ensures inserted nodes conform to Slate schema.',
            ]}
          />

          <EditorExample
            editor="prosemirror"
            title="HTML Insertion"
            description="ProseMirror uses DOMParser to parse HTML into ProseMirror nodes:"
            code={`import { DOMParser } from 'prosemirror-model';
import { schema } from './schema';

view.dom.addEventListener('beforeinput', (e) => {
  if (e.inputType === 'insertHTML' && e.dataTransfer) {
    e.preventDefault();
    const { state, dispatch } = view;
    
    const htmlString = e.dataTransfer.getData('text/html');
    const dom = new DOMParser(window).parseFromString(htmlString, 'text/html');
    
    // Parse HTML into ProseMirror nodes using schema
    const fragment = DOMParser.fromSchema(schema).parse(dom.body);
    
    // Insert fragment at selection
    const tr = state.tr.replaceSelection(fragment);
    dispatch(tr);
  }
});`}
            features={[
              '<strong>DOMParser:</strong> Uses ProseMirror\'s <code class="bg-bg-surface px-1.5 py-0.5 rounded text-[0.85em]">DOMParser.fromSchema()</code> to parse HTML.',
              '<strong>Schema-aware:</strong> HTML is parsed according to ProseMirror schema rules.',
              '<strong>Transaction-based:</strong> Creates a transaction for undo/redo support.',
            ]}
          />

          <EditorExample
            editor="draftjs"
            title="HTML Insertion"
            description="Draft.js uses convertFromHTML to convert HTML to ContentState:"
            code={`import { EditorState, ContentState } from 'draft-js';
import { stateFromHTML } from 'draft-js-import-html';

element.addEventListener('beforeinput', (e) => {
  if (e.inputType === 'insertHTML' && e.dataTransfer) {
    e.preventDefault();
    
    const htmlString = e.dataTransfer.getData('text/html');
    
    // Convert HTML to ContentState
    const contentState = stateFromHTML(htmlString);
    
    // Get current selection
    const selection = editorState.getSelection();
    
    // Insert content at selection
    const newContentState = Modifier.replaceWithFragment(
      editorState.getCurrentContent(),
      selection,
      contentState.getBlockMap()
    );
    
    const newState = EditorState.push(
      editorState,
      newContentState,
      'insert-fragment'
    );
    
    setEditorState(newState);
  }
});`}
            features={[
              '<strong>HTML import:</strong> Uses <code class="bg-bg-surface px-1.5 py-0.5 rounded text-[0.85em]">stateFromHTML</code> to convert HTML to ContentState.',
              '<strong>Block conversion:</strong> Converts HTML elements to Draft.js ContentBlocks.',
              '<strong>Modifier API:</strong> Uses <code class="bg-bg-surface px-1.5 py-0.5 rounded text-[0.85em]">Modifier.replaceWithFragment</code> to insert content.',
            ]}
          />
        </DocSection>

        <DocSection title="Related resources">
          <ul class="m-0 pl-6">
            <li class="mb-2">
              <a href="/docs/input-types" class="text-accent-primary no-underline">
                Input Types Overview →
              </a>
            </li>
          </ul>
        </DocSection>
  <TableOfContents slot="toc" headings={headings} />
</DocLayout>

