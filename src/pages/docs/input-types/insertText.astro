---
import DocLayout from '../../../components/docs/DocLayout.astro';
import DocSection from '../../../components/docs/DocSection.astro';
import DocAlert from '../../../components/docs/DocAlert.astro';
import DocInfoBox from '../../../components/docs/DocInfoBox.astro';
import EditorExample from '../../../components/EditorExample.astro';
import '../../../styles/global.css';
---

<DocLayout
  title="insertText"
  description="How insertText inputType inserts text characters and varies across browsers."
  currentPath={Astro.url.pathname}
>
        <DocSection title="Overview">
          <p class="m-0 mb-4">
            The <code class="bg-bg-muted px-1.5 py-0.5 rounded text-[0.85em]">insertText</code> inputType is triggered when the user types regular text characters (not formatting shortcuts). The text is inserted at the current cursor position or replaces selected text.
          </p>
        </DocSection>

        <DocSection title="Basic Behavior">
          <DocInfoBox title="Scenario 1: Cursor position (no selection)">
            <div class="space-y-4">
              <div>
                <h4 class="text-sm font-semibold mb-2 text-text-primary">Before (Cursor at position 5)</h4>
                <div class="bg-bg-surface border border-border-light rounded-md p-3 font-mono text-sm">
                  <div class="text-text-secondary">HTML:</div>
                  <div class="text-text-primary mt-1">&lt;p&gt;Hello<span class="bg-blue-200 dark:bg-blue-900/40 px-1 rounded">|</span>world&lt;/p&gt;</div>
                </div>
              </div>
              
              <div>
                <h4 class="text-sm font-semibold mb-2 text-text-primary">After typing 'x'</h4>
                <div class="bg-bg-surface border border-border-light rounded-md p-3 font-mono text-sm">
                  <div class="text-text-secondary">HTML:</div>
                  <div class="text-text-primary mt-1">&lt;p&gt;Hello<span class="bg-blue-200 dark:bg-blue-900/40">x</span>world&lt;/p&gt;</div>
                  <div class="text-text-secondary mt-2 text-xs">Text inserted at cursor position</div>
                </div>
              </div>
            </div>
          </DocInfoBox>

          <DocInfoBox title="Scenario 2: Text selected" class="mt-6">
            <div class="space-y-4">
              <div>
                <h4 class="text-sm font-semibold mb-2 text-text-primary">Before (Text selected)</h4>
                <div class="bg-bg-surface border border-border-light rounded-md p-3 font-mono text-sm">
                  <div class="text-text-secondary">HTML:</div>
                  <div class="text-text-primary mt-1">&lt;p&gt;Hello <span class="bg-yellow-200 dark:bg-yellow-900/40">world</span> text&lt;/p&gt;</div>
                </div>
              </div>
              
              <div>
                <h4 class="text-sm font-semibold mb-2 text-text-primary">After typing 'x' (Replaces selection)</h4>
                <div class="bg-bg-surface border border-border-light rounded-md p-3 font-mono text-sm">
                  <div class="text-text-secondary">HTML:</div>
                  <div class="text-text-primary mt-1">&lt;p&gt;Hello <span class="bg-blue-200 dark:bg-blue-900/40">x</span> text&lt;/p&gt;</div>
                  <div class="text-text-secondary mt-2 text-xs">Selected text replaced with new text</div>
                </div>
              </div>
            </div>
          </DocInfoBox>
        </DocSection>

        <DocSection title="IME Composition">
          <DocAlert type="info" class="mb-4">
            <p class="m-0 mb-2 text-sm">
              During IME composition, <code class="bg-white/50 dark:bg-black/20 px-1.5 py-0.5 rounded text-[0.85em]">insertText</code> events may fire multiple times as the user composes characters. The <code class="bg-white/50 dark:bg-black/20 px-1.5 py-0.5 rounded text-[0.85em]">e.data</code> property contains the composed text.
            </p>
            <p class="m-0 text-sm">
              See: <a href="/docs/ime-composition" class="text-accent-primary underline">IME & Composition</a> for more details.
            </p>
          </DocAlert>

          <DocAlert type="error" title="⚠️ Space Key During Composition">
            <p class="m-0 mb-2 text-sm">
              During IME composition, pressing the Space key may behave unexpectedly:
            </p>
            <ul class="m-0 mt-2 mb-2 pl-6 text-sm">
              <li class="mb-1">Space key may be ignored (no space inserted)</li>
              <li class="mb-1">Composition may be committed inconsistently</li>
              <li class="mb-1">Event order may differ from native text controls</li>
              <li class="mb-1">Behavior varies between browsers and IME implementations</li>
            </ul>
            <p class="m-0 text-sm">
              This can affect word boundary detection and autocomplete features.
            </p>
          </DocAlert>
        </DocSection>

        <DocSection title="Mobile Keyboard Text Prediction (Android)">
          <DocAlert type="error" title="⚠️ Android Samsung Keyboard Text Prediction">
            <p class="m-0 mb-2 text-sm">
              <strong>Android + Samsung Keyboard:</strong> When text prediction/suggestion features are enabled on Samsung keyboard, selecting suggested text may cause unexpected behavior:
            </p>
            <ul class="m-0 mt-2 mb-2 pl-6 text-sm">
              <li class="mb-1"><code class="bg-white/50 dark:bg-black/20 px-1.5 py-0.5 rounded text-[0.85em]">insertText</code> events may fire with the full suggested phrase instead of individual characters</li>
              <li class="mb-1">Multiple <code class="bg-white/50 dark:bg-black/20 px-1.5 py-0.5 rounded text-[0.85em]">input</code> events may fire for a single suggestion selection</li>
              <li class="mb-1">The <code class="bg-white/50 dark:bg-black/20 px-1.5 py-0.5 rounded text-[0.85em]">beforeinput</code> event may not fire before suggestion insertion</li>
              <li class="mb-1">Suggested text may replace more content than expected (entire words instead of partial words)</li>
              <li class="mb-1">Event timing may differ from manual typing, making it difficult to track changes accurately</li>
            </ul>
            <p class="m-0 text-sm">
              <strong>Impact:</strong> Text prediction can interfere with custom editing logic, undo/redo stacks, and change tracking systems.
            </p>
          </DocAlert>

          <DocInfoBox title="Workaround" class="mt-4">
            <p class="m-0 mb-2 text-sm text-text-secondary">
              To handle text prediction issues:
            </p>
            <ul class="m-0 pl-6 text-sm text-text-secondary">
              <li class="mb-1">Monitor both <code class="bg-bg-surface px-1.5 py-0.5 rounded text-[0.85em]">beforeinput</code> and <code class="bg-bg-surface px-1.5 py-0.5 rounded text-[0.85em]">input</code> events to catch all text insertions</li>
              <li class="mb-1">Compare DOM state before and after events to detect bulk text insertions</li>
              <li class="mb-1">Use <code class="bg-bg-surface px-1.5 py-0.5 rounded text-[0.85em]">e.data</code> property to identify suggested text vs manual typing</li>
              <li class="mb-1">Consider disabling text prediction via <code class="bg-bg-surface px-1.5 py-0.5 rounded text-[0.85em]">autocomplete="off"</code> or <code class="bg-bg-surface px-1.5 py-0.5 rounded text-[0.85em]">spellcheck="false"</code> if it interferes with your use case</li>
            </ul>
          </DocInfoBox>
        </DocSection>

        <DocSection title="Editor Internal Model & DOM Synchronization">
          <DocAlert type="warning" title="⚠️ Exception: preventDefault() and Model Updates">
            <p class="m-0 mb-2 text-sm">
              <strong>When editors use preventDefault() and update internal models:</strong>
            </p>
            <ul class="m-0 mt-2 mb-2 pl-6 text-sm">
              <li class="mb-1">Browser's default text insertion is prevented</li>
              <li class="mb-1">Editor inserts text into its internal model, then re-renders DOM</li>
              <li class="mb-1">Browser's undo stack may not include the text insertion (because default was prevented)</li>
              <li class="mb-1">If editor re-renders DOM from model, browser may not recognize the text as user-inserted</li>
              <li class="mb-1">Subsequent undo operations may not work correctly if browser and editor undo stacks are out of sync</li>
            </ul>
            <p class="m-0 text-sm">
              <strong>Best Practice:</strong> Always maintain your own undo stack when using <code class="bg-white/50 dark:bg-black/20 px-1.5 py-0.5 rounded text-[0.85em]">preventDefault()</code> on text insertion events.
            </p>
          </DocAlert>
        </DocSection>

        <DocSection title="Editor-Specific Handling">
          <p class="m-0 mb-4">
            Different editor frameworks handle text insertion differently. Here's how major editors implement insertText:
          </p>

          <EditorExample
            editor="slate"
            title="Text Insertion"
            description="Slate uses Transforms.insertText() to insert text at the current selection:"
            code={`import { Editor, Transforms } from 'slate';

element.addEventListener('beforeinput', (e) => {
  if (e.inputType === 'insertText' && e.data) {
    e.preventDefault();
    Transforms.insertText(editor, e.data);
  }
});

// Or handle in input event for composition
element.addEventListener('input', (e) => {
  const inputEvent = e as InputEvent;
  if (inputEvent.inputType === 'insertText' && inputEvent.data) {
    // Slate may have already handled this, but you can sync if needed
    // Check editor state and update if necessary
  }
});`}
            features={[
              '<strong>Transforms.insertText:</strong> Inserts text at the current selection position.',
              '<strong>Selection handling:</strong> Automatically handles collapsed and non-collapsed selections.',
              '<strong>Composition support:</strong> Can handle IME composition through multiple insertText events.',
            ]}
          />

          <EditorExample
            editor="prosemirror"
            title="Text Insertion"
            description="ProseMirror uses commands to insert text:"
            code={`import { insertText } from 'prosemirror-commands';

// In keymap or beforeinput handler
view.dom.addEventListener('beforeinput', (e) => {
  if (e.inputType === 'insertText' && e.data) {
    e.preventDefault();
    const { state, dispatch } = view;
    if (insertText(state, e.data, state.selection.$from.marks(), dispatch)) {
      // Handled
    }
  }
});

// ProseMirror also handles text input through its own input handling
// which integrates with the editor state and schema`}
            features={[
              '<strong>insertText command:</strong> Inserts text with current marks applied.',
              '<strong>Schema integration:</strong> Text insertion respects schema constraints.',
              '<strong>Transaction-based:</strong> All changes are applied as transactions for undo/redo support.',
            ]}
          />

          <EditorExample
            editor="draftjs"
            title="Text Insertion"
            description="Draft.js uses Modifier.insertText() to insert text:"
            code={`import { EditorState, Modifier } from 'draft-js';

function handleInsertText(editorState, text) {
  const contentState = editorState.getCurrentContent();
  const selection = editorState.getSelection();
  
  const newContentState = Modifier.insertText(
    contentState,
    selection,
    text,
    editorState.getCurrentInlineStyle()
  );
  
  return EditorState.push(
    editorState,
    newContentState,
    'insert-characters'
  );
}

// In beforeinput handler
element.addEventListener('beforeinput', (e) => {
  if (e.inputType === 'insertText' && e.data) {
    e.preventDefault();
    const newState = handleInsertText(editorState, e.data);
    setEditorState(newState);
  }
});`}
            features={[
              '<strong>Modifier.insertText:</strong> Inserts text into ContentState with current inline styles.',
              '<strong>ContentState:</strong> Text is stored in immutable ContentState objects.',
              '<strong>Style preservation:</strong> Current inline styles are applied to inserted text.',
            ]}
          />
        </DocSection>

        <DocSection title="Related resources">
          <ul class="m-0 pl-6">
            <li class="mb-2">
              <a href="/docs/input-types" class="text-accent-primary no-underline">
                Input Types Overview →
              </a>
            </li>
            <li class="mb-2">
              <a href="/docs/ime-composition" class="text-accent-primary no-underline">
                IME & Composition →
              </a>
            </li>
          </ul>
        </DocSection>
</DocLayout>

