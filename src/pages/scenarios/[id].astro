---
import { getCollection, getEntry } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import SiteNav from '../../components/SiteNav.astro';
import BaseHead from '../../components/BaseHead.astro';
import ScenarioFlow from '../../components/ScenarioFlow';
import '../../styles/global.css';

export const getStaticPaths = (async () => {
  // Use cases to determine which scenarios exist (backward compatibility)
  const cases = await getCollection('cases');
  const scenarioIds = Array.from(new Set(cases.map((c) => c.data.scenarioId)));
  return scenarioIds.map((scenarioId) => ({
    params: { id: scenarioId },
  }));
}) satisfies GetStaticPaths;

const scenarioId = Astro.params.id;

if (!scenarioId) {
  throw new Error('Scenario id is missing in route params.');
}

// Get scenario entry if it exists
const allScenarios = await getCollection('scenarios');
const scenarioEntry = allScenarios.find((s) => s.data.id === scenarioId) || null;

const allCases = await getCollection('cases');
const scenarioCases = allCases.filter((c) => c.data.scenarioId === scenarioId);

if (scenarioCases.length === 0) {
  throw new Error(`No cases found for scenario "${scenarioId}".`);
}

// Use scenario metadata, fallback to first case
const scenarioTitle = scenarioEntry?.data.title || scenarioCases[0].data.caseTitle;
const scenarioDescription = scenarioEntry?.data.description || scenarioCases[0].data.caseTitle;
const scenarioCategory = scenarioEntry?.data.category || undefined;

// Render scenario content if it exists
let scenarioContent = null;
if (scenarioEntry) {
  const { Content } = await scenarioEntry.render();
  scenarioContent = Content;
}

// Sort variants for readability.
scenarioCases.sort((a, b) => a.data.id.localeCompare(b.data.id));

const flowCases = scenarioCases.map((c) => ({
  id: c.data.id,
  caseTitle: c.data.caseTitle,
  os: c.data.os,
  browser: c.data.browser,
  device: c.data.device,
  keyboard: c.data.keyboard,
  status: c.data.status,
  slug: c.slug,
  tags: c.data.tags ?? [],
}));

// Build compatibility matrix: Browser x OS
const browsers = Array.from(new Set(scenarioCases.map((c) => c.data.browser))).sort();
const osList = Array.from(new Set(scenarioCases.map((c) => c.data.os))).sort();

const compatibilityMatrix = browsers.map((browser) => {
  const browserCases = scenarioCases.filter((c) => c.data.browser === browser);
  return {
    browser,
    osCoverage: osList.map((os) => {
      const osCases = browserCases.filter((c) => c.data.os === os);
      return {
        os,
        cases: osCases,
        hasCase: osCases.length > 0,
        versions: osCases.map((c) => ({
          osVersion: c.data.osVersion || 'Any',
          browserVersion: c.data.browserVersion || 'Any',
          caseId: c.data.id,
          slug: c.slug,
          status: c.data.status,
        })),
      };
    }),
  };
});

// Find related scenarios based on category and tags
const currentTags = scenarioEntry?.data.tags || scenarioCases[0].data.tags || [];
const currentCategory = scenarioEntry?.data.category || 'other';

const relatedScenarios = allScenarios
  .filter((s) => s.data.id !== scenarioId)
  .map((s) => {
    let score = 0;
    const scenarioTags = s.data.tags || [];
    const matchingTags = currentTags.filter((t) => scenarioTags.includes(t));
    
    // Same category = high priority
    if (s.data.category === currentCategory && currentCategory !== 'other') {
      score += 50;
    }
    
    // Matching tags
    score += matchingTags.length * 10;
    
    return { ...s, score, matchingTags };
  })
  .filter((s) => s.score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, 5);
---

<html lang="en">
  <head>
    <BaseHead title={`${scenarioTitle} – contenteditable scenario`} />
  </head>
  <body>
    <SiteNav />
    <main
      style="
        max-width: 1120px;
        margin: 0 auto;
        padding: 1.75rem 1.25rem 2.5rem;
      "
    >
      <header style="margin-bottom: 1.5rem;">
        <p style="margin: 0 0 0.45rem 0; font-size: 0.8rem; color: var(--text-muted);">
          Scenario
        </p>
        <h1
          style="
            font-size: 1.9rem;
            line-height: 1.2;
            margin: 0 0 0.5rem 0;
          "
        >
          {scenarioTitle}
        </h1>
        <p style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: var(--text-secondary);">
          {scenarioDescription}
        </p>
        {scenarioEntry?.data.category && (
          <div style="margin-bottom: 0.75rem;">
            <span
              style="
                display: inline-block;
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                background: var(--bg-muted);
                color: var(--text-secondary);
              "
            >
              {scenarioEntry.data.category}
            </span>
          </div>
        )}
        <div
          style="
            border-radius: 0.5rem;
            border: 1px solid var(--border-light);
            background: var(--bg-muted);
            padding: 0.75rem 0.9rem;
            font-size: 0.85rem;
          "
        >
          <div style="font-weight: 600; margin-bottom: 0.3rem; color: var(--text-primary);">
            Scenario ID
          </div>
          <div style="color: var(--text-secondary); line-height: 1.5; font-family: monospace; font-size: 0.8rem;">
            {scenarioId}
          </div>
        </div>
        {scenarioContent && (
          <div
            style="
              margin-top: 1rem;
              padding: 1rem;
              border-radius: 0.5rem;
              border: 1px solid var(--border-light);
              background: var(--bg-surface);
              font-size: 0.9rem;
              line-height: 1.6;
            "
          >
            <scenarioContent />
          </div>
        )}
      </header>

      <section
        aria-label="Scenario flow"
        style="
          border-radius: 0.75rem;
          border: 1px solid var(--border-light);
          background: var(--bg-surface);
          padding: 0.9rem 1rem;
          margin-bottom: 1.25rem;
        "
      >
        <h2
          style="
            font-size: 0.95rem;
            margin: 0 0 0.4rem 0;
          "
        >
          Scenario flow
        </h2>
        <p style="margin: 0 0 0.6rem 0; color: var(--text-secondary); font-size: 0.85rem;">
          Visual view of how this scenario connects to its concrete cases and environments. Nodes can be dragged and clicked.
        </p>
        <div style="height: 520px; border-radius: 0.6rem; border: 1px solid var(--border-light); overflow: hidden;">
          <ScenarioFlow
            client:load
            scenarioId={scenarioId}
            scenarioTitle={scenarioTitle}
            scenarioDescription={scenarioDescription}
            scenarioCategory={scenarioCategory}
            cases={flowCases}
          />
        </div>
      </section>

      <section
        aria-label="Variants for this scenario"
        style="
          border-radius: 0.75rem;
          border: 1px solid var(--border-light);
          background: var(--bg-surface);
          padding: 0.9rem 1rem;
          font-size: 0.85rem;
          margin-bottom: 1.1rem;
        "
      >
        <h2
          style="
            font-size: 0.95rem;
            margin: 0 0 0.4rem 0;
          "
        >
          Variants
        </h2>
        <p style="margin: 0 0 0.6rem 0; color: var(--text-secondary);">
          Each row is a concrete case for this scenario, with a dedicated document and playground.
        </p>
        <div style="overflow-x: auto;">
          <table
            style="
              width: 100%;
              border-collapse: collapse;
              font-size: 0.8rem;
            "
          >
            <thead>
              <tr>
                <th style="text-align: left; padding: 0.25rem 0.4rem;">Case</th>
                <th style="text-align: left; padding: 0.25rem 0.4rem;">OS</th>
                <th style="text-align: left; padding: 0.25rem 0.4rem;">Device</th>
                <th style="text-align: left; padding: 0.25rem 0.4rem;">Browser</th>
                <th style="text-align: left; padding: 0.25rem 0.4rem;">Keyboard</th>
                <th style="text-align: left; padding: 0.25rem 0.4rem;">Status</th>
              </tr>
            </thead>
            <tbody>
              {scenarioCases.map((c) => (
                <tr>
                  <td style="padding: 0.25rem 0.4rem;">
                    <a
                      href={`/cases/${c.slug}`}
                      style="
                        color: var(--text-primary);
                        text-decoration: none;
                      "
                    >
                      {c.data.id}
                    </a>
                  </td>
                        <td style="padding: 0.25rem 0.4rem;">
                          {c.data.os}
                          {c.data.osVersion && ` ${c.data.osVersion}`}
                        </td>
                        <td style="padding: 0.25rem 0.4rem;">
                          {c.data.device}
                          {c.data.deviceVersion && ` ${c.data.deviceVersion}`}
                        </td>
                        <td style="padding: 0.25rem 0.4rem;">
                          {c.data.browser}
                          {c.data.browserVersion && ` ${c.data.browserVersion}`}
                        </td>
                        <td style="padding: 0.25rem 0.4rem;">{c.data.keyboard}</td>
                  <td style="padding: 0.25rem 0.4rem;">{c.data.status}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>

      {scenarioCases.length > 1 && (
        <section
          aria-label="Browser compatibility matrix"
          style="
            border-radius: 0.75rem;
            border: 1px solid var(--border-light);
            background: var(--bg-surface);
            padding: 0.9rem 1rem;
            font-size: 0.85rem;
            margin-bottom: 1.1rem;
          "
        >
          <h2
            style="
              font-size: 0.95rem;
              margin: 0 0 0.4rem 0;
            "
          >
            Browser compatibility
          </h2>
          <p style="margin: 0 0 0.6rem 0; color: var(--text-secondary); font-size: 0.8rem;">
            This matrix shows which browser and OS combinations have documented cases for this
            scenario. Click on a cell to view the specific case.
          </p>
          <div style="overflow-x: auto;">
            <table
              style="
                width: 100%;
                border-collapse: collapse;
                font-size: 0.75rem;
              "
            >
              <thead>
                <tr>
                  <th
                    style="
                      text-align: left;
                      padding: 0.4rem 0.5rem;
                      border-bottom: 2px solid var(--border-light);
                      background: var(--bg-muted);
                      position: sticky;
                      left: 0;
                      z-index: 1;
                    "
                  >
                    Browser
                  </th>
                  {osList.map((os) => (
                    <th
                      style="
                        text-align: center;
                        padding: 0.4rem 0.5rem;
                        border-bottom: 2px solid var(--border-light);
                        background: var(--bg-muted);
                        font-weight: 600;
                      "
                    >
                      {os}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {compatibilityMatrix.map((row) => (
                  <tr>
                    <td
                      style="
                        padding: 0.4rem 0.5rem;
                        border-bottom: 1px solid var(--border-light);
                        background: var(--bg-muted);
                        font-weight: 600;
                        position: sticky;
                        left: 0;
                        z-index: 1;
                      "
                    >
                      {row.browser}
                    </td>
                    {row.osCoverage.map((cell) => (
                      <td
                        style="
                          padding: 0.3rem 0.4rem;
                          border-bottom: 1px solid var(--border-light);
                          text-align: center;
                          min-width: 80px;
                        "
                      >
                        {cell.hasCase ? (
                          <div
                            style="
                              display: flex;
                              flex-direction: column;
                              gap: 0.2rem;
                              align-items: center;
                            "
                          >
                            {cell.versions.map((v) => (
                              <a
                                href={`/cases/${v.slug}`}
                                class={`matrix-case-link ${v.status}`}
                                title={`${v.caseId}: ${row.browser} ${v.browserVersion} on ${cell.os} ${v.osVersion}`}
                              >
                                {v.caseId}
                              </a>
                            ))}
                            <div
                              style="
                                font-size: 0.65rem;
                                color: var(--text-muted);
                                margin-top: 0.1rem;
                              "
                            >
                              {cell.versions
                                .map((v) => `${v.browserVersion || 'Any'}`)
                                .join(', ')}
                            </div>
                          </div>
                        ) : (
                          <span style="color: var(--text-faint);">—</span>
                        )}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div
            style="
              margin-top: 0.6rem;
              padding-top: 0.6rem;
              border-top: 1px solid var(--border-light);
              font-size: 0.75rem;
              color: var(--text-muted);
            "
          >
            <div style="display: flex; gap: 1rem; align-items: center;">
              <div style="display: flex; align-items: center; gap: 0.3rem;">
                <span
                  style="
                    display: inline-block;
                    width: 12px;
                    height: 12px;
                    border-radius: 4px;
                    background: var(--status-confirmed);
                  "
                ></span>
                <span>Confirmed</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.3rem;">
                <span
                  style="
                    display: inline-block;
                    width: 12px;
                    height: 12px;
                    border-radius: 4px;
                    background: var(--status-draft);
                  "
                ></span>
                <span>Draft</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.3rem;">
                <span style="color: var(--text-faint);">—</span>
                <span>No case documented</span>
              </div>
            </div>
          </div>
        </section>
      )}

      <section
        aria-label="Cases for this scenario"
        style="
          border-radius: 0.75rem;
          border: 1px solid var(--border-light);
          background: var(--bg-surface);
          padding: 0.9rem 1rem;
          font-size: 0.85rem;
        "
      >
        <h2
          style="
            font-size: 0.95rem;
            margin: 0 0 0.5rem 0;
          "
        >
          Cases
        </h2>
        <p style="margin: 0 0 0.6rem 0; color: var(--text-secondary);">
          Open a case to see the detailed description and its dedicated playground.
        </p>

        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 0.9rem;
          "
        >
          {scenarioCases.map((c) => (
            <article
              style="
                border-radius: 0.75rem;
                border: 1px solid var(--border-light);
                padding: 0.8rem 0.9rem;
                transition: border-color 0.2s, background-color 0.2s;
                cursor: pointer;
              "
              onmouseover="this.style.borderColor='var(--accent-primary)'; this.style.backgroundColor='var(--bg-muted)';"
              onmouseout="this.style.borderColor='var(--border-light)'; this.style.backgroundColor='transparent';"
              onclick={`window.location.href='/cases/${c.slug}'`}
            >
              <a
                href={`/cases/${c.slug}`}
                style="
                  text-decoration: none;
                  color: inherit;
                  display: block;
                "
              >
                <h3
                  style="
                    font-size: 0.9rem;
                    margin: 0 0 0.35rem 0;
                    color: var(--text-primary);
                    transition: color 0.2s;
                  "
                  onmouseover="this.style.color='var(--accent-primary)';"
                  onmouseout="this.style.color='var(--text-primary)';"
                >
                  {c.data.caseTitle}
                </h3>
              </a>
              <p style="margin: 0 0 0.35rem 0; color: var(--text-secondary);">
                OS: {c.data.os}
                {c.data.osVersion && ` ${c.data.osVersion}`} · Device: {c.data.device}
                {c.data.deviceVersion && ` ${c.data.deviceVersion}`} · Browser: {c.data.browser}
                {c.data.browserVersion && ` ${c.data.browserVersion}`} · Keyboard: {c.data.keyboard}
              </p>
              <a
                href={`/cases/${c.slug}`}
                style="
                  font-size: 0.8rem;
                  color: var(--text-primary);
                  font-weight: 500;
                  margin-top: 0.5rem;
                  display: inline-block;
                  text-decoration: none;
                  transition: color 0.2s;
                "
                onmouseover="this.style.color='var(--accent-primary)';"
                onmouseout="this.style.color='var(--text-primary)';"
              >
                Open case →
              </a>
            </article>
          ))}
        </div>
      </section>

      {relatedScenarios.length > 0 && (
        <section
          aria-label="Related scenarios"
          style="
            border-radius: 0.75rem;
            border: 1px solid var(--border-light);
            background: var(--bg-surface);
            padding: 0.9rem 1rem;
            font-size: 0.85rem;
            margin-top: 1.5rem;
          "
        >
          <h2
            style="
              font-size: 0.95rem;
              margin: 0 0 0.5rem 0;
            "
          >
            Related Scenarios
          </h2>
          <p style="margin: 0 0 0.6rem 0; color: var(--text-secondary);">
            Other scenarios that share similar tags or category.
          </p>
          <div
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
              gap: 0.9rem;
            "
          >
            {relatedScenarios.map((s) => {
              const relatedCases = allCases.filter((c) => c.data.scenarioId === s.data.id);
              const relationType = s.matchingTags.length > 0
                ? `Tags: ${s.matchingTags.join(', ')}`
                : s.data.category === currentCategory
                ? `Category: ${currentCategory}`
                : 'Related';
              
              return (
                <article
                  style="
                    border-radius: 0.75rem;
                    border: 1px solid var(--border-light);
                    padding: 0.8rem 0.9rem;
                  "
                >
                  <div
                    style="
                      display: inline-block;
                      padding: 0.2rem 0.5rem;
                      border-radius: 4px;
                      background: var(--bg-muted);
                      color: var(--text-secondary);
                      font-size: 0.7rem;
                      margin-bottom: 0.4rem;
                    "
                  >
                    {relationType}
                  </div>
                  <h3
                    style="
                      font-size: 0.9rem;
                      margin: 0 0 0.35rem 0;
                    "
                  >
                    <a
                      href={`/scenarios/${encodeURIComponent(s.data.id)}`}
                      style="
                        color: var(--text-primary);
                        text-decoration: none;
                      "
                    >
                      {s.data.title}
                    </a>
                  </h3>
                  <p style="margin: 0 0 0.35rem 0; color: var(--text-secondary); font-size: 0.8rem;">
                    {s.data.description || 'No description available.'}
                  </p>
                  <div style="font-size: 0.75rem; color: var(--text-muted);">
                    {relatedCases.length} case{relatedCases.length === 1 ? '' : 's'}
                  </div>
                </article>
              );
            })}
          </div>
        </section>
      )}
    </main>
  </body>
</html>

<style>
  .matrix-case-link {
    display: inline-block;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    color: white;
    text-decoration: none;
    font-size: 0.7rem;
    font-weight: 500;
  }

  .matrix-case-link.confirmed {
    background: var(--status-confirmed);
  }

  .matrix-case-link.draft {
    background: var(--status-draft);
  }
</style>


