---
import { getCollection, getEntry } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import SiteNav from '../../components/SiteNav.astro';
import BaseHead from '../../components/BaseHead.astro';
import ScenarioFlow from '../../components/ScenarioFlow';
import ScenariosSidebar from '../../components/ScenariosSidebar.astro';
import EditOnGitHub from '../../components/EditOnGitHub.astro';
import Comments from '../../components/Comments.astro';
import { ResizableSidebar } from '../../components/ResizableSidebar';
import '../../styles/global.css';

export const getStaticPaths = (async () => {
  // Use cases to determine which scenarios exist (backward compatibility)
  const cases = await getCollection('cases');
  const scenarioIds = Array.from(new Set(cases.map((c) => c.data.scenarioId)));
  return scenarioIds.map((scenarioId) => ({
    params: { id: scenarioId },
  }));
}) satisfies GetStaticPaths;

const scenarioId = Astro.params.id;

if (!scenarioId) {
  throw new Error('Scenario id is missing in route params.');
}

// Get scenario entry if it exists
const allScenarios = await getCollection('scenarios', ({ data }) => data.locale === 'en');
const allScenariosAllLocales = await getCollection('scenarios'); // For sidebar - all locales
const scenarioEntry = allScenarios.find((s) => s.data.id === scenarioId) || null;

const allCases = await getCollection('cases', ({ data }) => data.locale === 'en');
const allCasesAllLocales = await getCollection('cases'); // For sidebar - all locales
const scenarioCases = allCases.filter((c) => c.data.scenarioId === scenarioId);

if (scenarioCases.length === 0) {
  throw new Error(`No cases found for scenario "${scenarioId}".`);
}

// Use scenario metadata, fallback to first case
const scenarioTitle = scenarioEntry?.data.title || scenarioCases[0].data.caseTitle;
const scenarioDescription = scenarioEntry?.data.description || scenarioCases[0].data.caseTitle;
const scenarioCategory = scenarioEntry?.data.category || undefined;

// Render scenario content if it exists
const { Content: ScenarioContent } = scenarioEntry ? await scenarioEntry.render() : { Content: null };

// Sort variants for readability.
scenarioCases.sort((a, b) => a.data.id.localeCompare(b.data.id));

// Group cases by language (extract from keyboard field)
const groupCasesByLanguage = (cases: typeof scenarioCases) => {
  const languageGroups = new Map<string, typeof scenarioCases>();
  
  cases.forEach((c) => {
    const keyboard = c.data.keyboard || '';
    // Extract language from keyboard field (e.g., "Japanese (IME)" -> "Japanese")
    let language = keyboard;
    if (keyboard.includes('(')) {
      language = keyboard.split('(')[0].trim();
    } else if (keyboard.includes('IME')) {
      language = keyboard.replace('IME', '').trim();
    }
    
    // Normalize language names
    if (language.toLowerCase().includes('korean')) language = 'Korean';
    else if (language.toLowerCase().includes('japanese')) language = 'Japanese';
    else if (language.toLowerCase().includes('chinese')) language = 'Chinese';
    else if (language.toLowerCase().includes('thai')) language = 'Thai';
    else if (language.toLowerCase().includes('vietnamese')) language = 'Vietnamese';
    else if (language.toLowerCase().includes('arabic')) language = 'Arabic';
    else if (language.toLowerCase().includes('hindi') || language.toLowerCase().includes('devanagari')) language = 'Hindi/Devanagari';
    else if (language.toLowerCase().includes('hebrew')) language = 'Hebrew';
    else language = keyboard; // Fallback to full keyboard name
    
    if (!languageGroups.has(language)) {
      languageGroups.set(language, []);
    }
    languageGroups.get(language)!.push(c);
  });
  
  return Array.from(languageGroups.entries())
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([language, cases]) => ({ language, cases }));
};

const casesByLanguage = groupCasesByLanguage(scenarioCases);
const hasMultipleLanguages = casesByLanguage.length > 1;

const flowCases = scenarioCases.map((c) => ({
  id: c.data.id,
  caseTitle: c.data.caseTitle,
  os: c.data.os,
  browser: c.data.browser,
  device: c.data.device,
  keyboard: c.data.keyboard,
  status: c.data.status,
  slug: c.slug,
  tags: c.data.tags ?? [],
}));

// Build compatibility matrix: Browser x OS
const browsers = Array.from(new Set(scenarioCases.map((c) => c.data.browser))).sort();
const osList = Array.from(new Set(scenarioCases.map((c) => c.data.os))).sort();

const compatibilityMatrix = browsers.map((browser) => {
  const browserCases = scenarioCases.filter((c) => c.data.browser === browser);
  return {
    browser,
    osCoverage: osList.map((os) => {
      const osCases = browserCases.filter((c) => c.data.os === os);
      return {
        os,
        cases: osCases,
        hasCase: osCases.length > 0,
        versions: osCases.map((c) => ({
          osVersion: c.data.osVersion || 'Any',
          browserVersion: c.data.browserVersion || 'Any',
          caseId: c.data.id,
          slug: c.slug,
          status: c.data.status,
        })),
      };
    }),
  };
});

// Find related scenarios based on category and tags
const currentTags = scenarioEntry?.data.tags || scenarioCases[0].data.tags || [];
const currentCategory = scenarioEntry?.data.category || 'other';

const relatedScenarios = allScenarios
  .filter((s) => s.data.id !== scenarioId)
  .map((s) => {
    let score = 0;
    const scenarioTags = s.data.tags || [];
    const matchingTags = currentTags.filter((t) => scenarioTags.includes(t));
    
    // Same category = high priority
    if (s.data.category === currentCategory && currentCategory !== 'other') {
      score += 50;
    }
    
    // Matching tags
    score += matchingTags.length * 10;
    
    return { ...s, score, matchingTags };
  })
  .filter((s) => s.score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, 5);

---

<html lang="en">
  <head>
    <BaseHead title={`${scenarioTitle} – contenteditable scenario`} />
  </head>
  <body>
    <SiteNav />
    <main class="flex max-w-full m-0 p-0">
      <ResizableSidebar client:load storageKey="scenarios-sidebar-width">
        <ScenariosSidebar
          allScenarios={allScenariosAllLocales}
          allCases={allCasesAllLocales}
          currentScenarioId={scenarioId}
          locale="en"
        />
      </ResizableSidebar>

      <section class="flex-1 max-w-[1120px] mx-auto py-7 px-5 pb-10 w-full">
      <header data-ui="scenario-header" class="mb-6">
        <p class="m-0 mb-1.5 text-xs text-text-muted">
          Scenario
        </p>
        <h1 class="text-[1.9rem] leading-[1.2] m-0 mb-2">
          {scenarioTitle}
        </h1>
        <p 
          data-ui="description"
          class="m-0 mb-3 text-sm text-text-secondary"
        >
          {scenarioDescription}
        </p>
        {scenarioEntry?.data.category && (
          <div data-ui="category" class="mb-3">
            <span class="inline-block text-xs px-2 py-1 rounded bg-bg-muted text-text-secondary">
              {scenarioEntry.data.category}
            </span>
          </div>
        )}
        <div
          data-ui="scenario-id"
          class="rounded-lg border border-border-light bg-bg-muted p-3 px-3.5 text-sm"
        >
          <div class="font-semibold mb-1 text-text-primary">
            Scenario ID
          </div>
          <div class="text-text-secondary leading-relaxed font-mono text-xs">
            {scenarioId}
          </div>
        </div>
        <div class="mt-3">
          <EditOnGitHub 
            filePath={scenarioEntry ? `src/content/scenarios/${scenarioEntry.id}.md` : `src/content/scenarios/scenario-${scenarioId}.md`} 
          />
        </div>
        {ScenarioContent && scenarioEntry && (
          <div
            data-ui="scenario-content"
            class="mt-4 p-5 rounded-lg border border-border-light bg-bg-surface text-sm leading-relaxed"
          >
            <h2 class="text-base m-0 mb-5 text-text-primary font-semibold border-b-2 border-accent-primary/30 pb-3">
              Details
            </h2>
            <div class="scenario-markdown">
              <ScenarioContent />
            </div>
          </div>
        )}
      </header>

      <section
        data-ui="scenario-flow"
        aria-label="Scenario flow"
        class="rounded-xl border border-border-light bg-bg-surface p-3.5 px-4 mb-5"
      >
        <h2 class="text-[0.95rem] m-0 mb-1.5">
          Scenario flow
        </h2>
        <p class="m-0 mb-2.5 text-text-secondary text-sm">
          Visual view of how this scenario connects to its concrete cases and environments. Nodes can be dragged and clicked.
        </p>
        <div class="h-[520px] rounded-lg border border-border-light overflow-hidden">
          <ScenarioFlow
            client:load
            scenarioId={scenarioId}
            scenarioTitle={scenarioTitle}
            scenarioDescription={scenarioDescription}
            scenarioCategory={scenarioCategory}
            cases={flowCases}
          />
        </div>
      </section>

      <section
        data-ui="variants"
        aria-label="Variants for this scenario"
        class="rounded-xl border border-border-light bg-bg-surface p-3.5 px-4 text-sm mb-4"
      >
        <h2 class="text-[0.95rem] m-0 mb-1.5">
          Variants
        </h2>
        <p class="m-0 mb-2.5 text-text-secondary">
          Each row is a concrete case for this scenario, with a dedicated document and playground.
        </p>
        <div class="overflow-x-auto">
          <table class="w-full border-collapse text-xs">
            <thead>
              <tr>
                <th class="text-left px-1 py-1">Case</th>
                <th class="text-left px-1 py-1">OS</th>
                <th class="text-left px-1 py-1">Device</th>
                <th class="text-left px-1 py-1">Browser</th>
                <th class="text-left px-1 py-1">Keyboard</th>
                <th class="text-left px-1 py-1">Status</th>
              </tr>
            </thead>
            <tbody>
              {scenarioCases.map((c) => (
                <tr>
                  <td class="p-1 px-1.5">
                    <a
                      href={`/cases/${c.slug}`}
                      class="text-text-primary no-underline"
                    >
                      {c.data.id}
                    </a>
                  </td>
                  <td class="px-1.5 py-1">
                    {c.data.os}
                    {c.data.osVersion && ` ${c.data.osVersion}`}
                  </td>
                  <td class="px-1.5 py-1">
                    {c.data.device}
                    {c.data.deviceVersion && ` ${c.data.deviceVersion}`}
                  </td>
                  <td class="px-1.5 py-1">
                    {c.data.browser}
                    {c.data.browserVersion && ` ${c.data.browserVersion}`}
                  </td>
                  <td class="px-1.5 py-1">{c.data.keyboard}</td>
                  <td class="px-1.5 py-1">{c.data.status}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>

      {scenarioCases.length > 1 && (
        <section
          data-ui="browser-compatibility"
          aria-label="Browser compatibility matrix"
          class="rounded-xl border border-border-light bg-bg-surface p-3.5 px-4 text-sm mb-4"
        >
          <h2 class="text-[0.95rem] m-0 mb-1.5">
            Browser compatibility
          </h2>
          <p class="m-0 mb-2.5 text-text-secondary text-xs">
            This matrix shows which browser and OS combinations have documented cases for this
            scenario. Click on a cell to view the specific case.
          </p>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse text-xs">
              <thead>
                <tr>
                  <th class="text-left px-2 py-1.5 border-b-2 border-border-light bg-bg-muted sticky left-0 z-[1]">
                    Browser
                  </th>
                  {osList.map((os) => (
                    <th class="text-center px-2 py-1.5 border-b-2 border-border-light bg-bg-muted font-semibold">
                      {os}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {compatibilityMatrix.map((row) => (
                  <tr>
                    <td class="px-2 py-1.5 border-b border-border-light bg-bg-muted font-semibold sticky left-0 z-[1]">
                      {row.browser}
                    </td>
                    {row.osCoverage.map((cell) => (
                      <td class="px-1.5 py-1 border-b border-border-light text-center min-w-[80px]">
                        {cell.hasCase ? (
                          <div class="flex flex-col gap-0.5 items-center">
                            {cell.versions.map((v) => (
                              <a
                                href={`/cases/${v.slug}`}
                                class={`matrix-case-link ${v.status}`}
                                title={`${v.caseId}: ${row.browser} ${v.browserVersion} on ${cell.os} ${v.osVersion}`}
                              >
                                {v.caseId}
                              </a>
                            ))}
                            <div class="text-[0.65rem] text-text-muted mt-0.5">
                              {cell.versions
                                .map((v) => `${v.browserVersion || 'Any'}`)
                                .join(', ')}
                            </div>
                          </div>
                        ) : (
                          <span class="text-text-faint">—</span>
                        )}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div class="mt-2.5 pt-2.5 border-t border-border-light text-xs text-text-muted">
            <div class="flex gap-4 items-center flex-wrap">
              <div class="flex items-center gap-1.5">
                <span class="inline-block w-3 h-3 rounded bg-status-confirmed"></span>
                <span>Confirmed</span>
              </div>
              <div class="flex items-center gap-1.5">
                <span class="inline-block w-3 h-3 rounded bg-status-draft"></span>
                <span>Draft</span>
              </div>
              <div class="flex items-center gap-1.5">
                <span class="text-text-faint">—</span>
                <span>No case documented</span>
              </div>
            </div>
          </div>
        </section>
      )}

      <section
        data-ui="cases"
        aria-label="Cases for this scenario"
        class="rounded-xl border border-border-light bg-bg-surface p-3.5 px-4 text-sm"
      >
        <h2 class="text-[0.95rem] m-0 mb-2">
          Cases
        </h2>
        <p class="m-0 mb-2.5 text-text-secondary">
          {hasMultipleLanguages 
            ? `This scenario affects multiple languages. Cases are grouped by language/input method below.`
            : 'Open a case to see the detailed description and its dedicated playground.'}
        </p>

        {hasMultipleLanguages ? (
          <div class="space-y-6">
            {casesByLanguage.map(({ language, cases }) => (
              <div data-ui="language-group" class="border-l-4 border-accent-primary pl-4">
                <div class="flex items-center gap-2 mb-3">
                  <h3 class="text-sm font-semibold text-text-primary m-0">
                    {language}
                  </h3>
                  <span class="text-xs text-text-muted bg-bg-muted px-2 py-0.5 rounded">
                    {cases.length} case{cases.length === 1 ? '' : 's'}
                  </span>
                </div>
                <div class="grid grid-cols-[repeat(auto-fit,minmax(240px,1fr))] gap-3.5">
                  {cases.map((c) => (
                    <article
                      class="rounded-xl border border-border-light p-3.5 px-3.5 transition-colors cursor-pointer hover:border-accent-primary hover:bg-bg-muted"
                      onclick={`window.location.href='/cases/${c.slug}'`}
                    >
                      <a
                        href={`/cases/${c.slug}`}
                        class="no-underline text-inherit block"
                      >
                        <h4 class="text-sm m-0 mb-1.5 text-text-primary transition-colors hover:text-accent-primary">
                          {c.data.caseTitle}
                        </h4>
                      </a>
                      <p class="m-0 mb-1.5 text-text-secondary">
                        OS: {c.data.os}
                        {c.data.osVersion && ` ${c.data.osVersion}`} · Device: {c.data.device}
                        {c.data.deviceVersion && ` ${c.data.deviceVersion}`} · Browser: {c.data.browser}
                        {c.data.browserVersion && ` ${c.data.browserVersion}`}
                      </p>
                      <a
                        href={`/cases/${c.slug}`}
                        class="text-xs text-text-primary font-medium mt-2 inline-block no-underline transition-colors hover:text-accent-primary"
                      >
                        Open case →
                      </a>
                    </article>
                  ))}
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="grid grid-cols-[repeat(auto-fit,minmax(240px,1fr))] gap-3.5">
            {scenarioCases.map((c) => (
              <article
                class="rounded-xl border border-border-light p-3.5 px-3.5 transition-colors cursor-pointer hover:border-accent-primary hover:bg-bg-muted"
                onclick={`window.location.href='/cases/${c.slug}'`}
              >
                <a
                  href={`/cases/${c.slug}`}
                  class="no-underline text-inherit block"
                >
                  <h3 class="text-sm m-0 mb-1.5 text-text-primary transition-colors hover:text-accent-primary">
                    {c.data.caseTitle}
                  </h3>
                </a>
                <p class="m-0 mb-1.5 text-text-secondary">
                  OS: {c.data.os}
                  {c.data.osVersion && ` ${c.data.osVersion}`} · Device: {c.data.device}
                  {c.data.deviceVersion && ` ${c.data.deviceVersion}`} · Browser: {c.data.browser}
                  {c.data.browserVersion && ` ${c.data.browserVersion}`} · Keyboard: {c.data.keyboard}
                </p>
                <a
                  href={`/cases/${c.slug}`}
                  class="text-xs text-text-primary font-medium mt-2 inline-block no-underline transition-colors hover:text-accent-primary"
                >
                  Open case →
                </a>
              </article>
            ))}
          </div>
        )}
      </section>

      {relatedScenarios.length > 0 && (
        <section
          data-ui="related-scenarios"
          aria-label="Related scenarios"
          class="rounded-xl border border-border-light bg-bg-surface p-3.5 px-4 text-sm mt-6"
        >
          <h2 class="text-[0.95rem] m-0 mb-2">
            Related Scenarios
          </h2>
          <p class="m-0 mb-2.5 text-text-secondary">
            Other scenarios that share similar tags or category.
          </p>
          <div class="grid grid-cols-[repeat(auto-fit,minmax(240px,1fr))] gap-3.5">
            {relatedScenarios.map((s) => {
              const relatedCases = allCases.filter((c) => c.data.scenarioId === s.data.id);
              const relationType = s.matchingTags.length > 0
                ? `Tags: ${s.matchingTags.join(', ')}`
                : s.data.category === currentCategory
                ? `Category: ${currentCategory}`
                : 'Related';
              
              return (
                <article class="rounded-xl border border-border-light p-3.5 px-3.5">
                  <div class="inline-block px-2 py-1 rounded bg-bg-muted text-text-secondary text-xs mb-1.5">
                    {relationType}
                  </div>
                  <h3 class="text-sm m-0 mb-1.5">
                    <a
                      href={`/scenarios/${encodeURIComponent(s.data.id)}`}
                      class="text-text-primary no-underline"
                    >
                      {s.data.title}
                    </a>
                  </h3>
                  <p class="m-0 mb-1.5 text-text-secondary text-xs">
                    {s.data.description || 'No description available.'}
                  </p>
                  <div class="text-xs text-text-muted">
                    {relatedCases.length} case{relatedCases.length === 1 ? '' : 's'}
                  </div>
                </article>
              );
            })}
          </div>
        </section>
      )}

      <Comments
        repo="easylogic/contenteditable"
        repoId=""
        category="Q&A"
        categoryId=""
        mapping={`pathname`}
        reactionsEnabled={true}
        inputPosition="bottom"
        theme="preferred_color_scheme"
        lang="en"
      />
      </section>
    </main>
  </body>
</html>

<style>
  .matrix-case-link {
    display: inline-block;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    color: white;
    text-decoration: none;
    font-size: 0.7rem;
    font-weight: 500;
  }

  .matrix-case-link.confirmed {
    background: var(--status-confirmed);
  }

  .matrix-case-link.draft {
    background: var(--status-draft);
  }
</style>


