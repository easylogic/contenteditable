---
import { getCollection } from 'astro:content';
import SiteNav from '../components/SiteNav.astro';
import BaseHead from '../components/BaseHead.astro';
import '../styles/global.css';

const allCases = await getCollection('cases', ({ data }) => data.locale === 'en');

const locales = Array.from(new Set(allCases.map((entry) => entry.data.locale))).sort();
const defaultLocale = locales.includes('en') ? 'en' : locales[0];

// Statistics for display
const totalCases = allCases.length;
const confirmedCount = allCases.filter((c) => c.data.status === 'confirmed').length;
const draftCount = allCases.filter((c) => c.data.status === 'draft').length;

const allTags = Array.from(
  new Set(
    allCases.flatMap((entry) => entry.data.tags ?? []),
  ),
).sort();
---

<html lang="en">
  <head>
    <BaseHead title="contenteditable cases" description="Individual incident reports documenting contenteditable behavior across environments." />
  </head>
  <body>
    <SiteNav />
    <main class="max-w-[1120px] mx-auto py-7 px-5 pb-10">
      <header class="mb-6">
        <h1 class="text-[2rem] leading-[1.1] m-0 mb-2">
          contenteditable cases
        </h1>
        <p class="m-0 mb-3 text-[0.95rem] text-text-secondary">
          Individual incident reports (cases) collected from experiments. Each case documents a
          concrete contenteditable behavior observed in a specific environment. Filter by metadata
          and follow links to reproduce them in the dedicated playgrounds.
        </p>
        <div class="flex gap-4 text-sm text-text-muted">
          <span>
            <strong class="text-text-primary">{totalCases}</strong> total cases
          </span>
          <span>
            <strong class="text-status-confirmed">{confirmedCount}</strong> confirmed
          </span>
          <span>
            <strong class="text-status-draft">{draftCount}</strong> draft
          </span>
        </div>
      </header>

      <section class="rounded-xl border border-border-light bg-bg-surface px-3.5 py-3 mb-4">
        <form class="grid grid-cols-[repeat(auto-fit,minmax(150px,1fr))] gap-3 items-end">
          <div>
            <label class="block text-xs font-medium mb-0.5">
              Locale
            </label>
            <select
              name="locale"
              value={Astro.url.searchParams.get('locale') ?? defaultLocale}
              class="w-full px-1.5 py-1.5 rounded-md border border-border-medium text-sm"
            >
              {locales.map((locale) => (
                <option value={locale}>{locale}</option>
              ))}
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium mb-0.5">
              Text search
            </label>
            <input
              type="search"
              name="q"
              value={Astro.url.searchParams.get('q') ?? ''}
              placeholder="Search in title or tags"
              class="w-full px-2 py-1.5 rounded-md border border-border-medium text-sm"
            />
          </div>

          <div>
            <label class="block text-xs font-medium mb-0.5">
              Status
            </label>
            <select
              name="status"
              value={Astro.url.searchParams.get('status') ?? 'all'}
              class="w-full px-1.5 py-1.5 rounded-md border border-border-medium text-sm"
            >
              <option value="all">all</option>
              <option value="confirmed">confirmed</option>
              <option value="draft">draft</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium mb-0.5">
              Tag
            </label>
            <select
              name="tag"
              value={Astro.url.searchParams.get('tag') ?? 'all'}
              class="w-full px-1.5 py-1.5 rounded-md border border-border-medium text-sm"
            >
              <option value="all">all</option>
              {allTags.map((tag) => (
                <option value={tag}>{tag}</option>
              ))}
            </select>
          </div>

          <div>
            <button
              type="submit"
              class="w-full px-3 py-1.5 rounded-full border border-text-primary bg-text-primary text-bg-surface text-sm cursor-pointer hover:opacity-90 transition-opacity"
            >
              Apply filters
            </button>
          </div>
        </form>
      </section>

      <section>
        {(() => {
          const searchParams = Astro.url.searchParams;
          const locale = searchParams.get('locale') ?? defaultLocale;
          const q = (searchParams.get('q') ?? '').toLowerCase();
          const statusFilter = searchParams.get('status') ?? 'all';
          const tagFilter = searchParams.get('tag') ?? 'all';

          const filtered = allCases.filter((entry) => {
            if (entry.data.locale !== locale) return false;
            if (statusFilter !== 'all' && entry.data.status !== statusFilter) return false;
            if (tagFilter !== 'all' && !entry.data.tags.includes(tagFilter)) return false;
            if (!q) return true;

            const haystack =
              `${entry.data.caseTitle} ${entry.data.os} ${entry.data.device} ${entry.data.browser} ${entry.data.keyboard} ${entry.data.tags.join(
                ' ',
              )}`.toLowerCase();

            return haystack.includes(q);
          });

          if (filtered.length === 0) {
            return (
              <p class="text-sm text-text-muted">
                No cases match the current filters. Try a different query or status.
              </p>
            );
          }

          return (
            <div class="grid grid-cols-[repeat(auto-fit,minmax(260px,1fr))] gap-3.5">
              {filtered.map((entry) => (
                <article
                  class="rounded-xl border border-border-light bg-bg-surface px-4 py-3.5 flex flex-col gap-1.5 hover:border-accent-primary hover:bg-bg-muted transition-colors cursor-pointer"
                  onclick={`window.location.href='/cases/${entry.slug}'`}
                >
                  <header>
                    <div class="flex justify-between items-center gap-2 mb-0.5">
                      <h2 class="text-[0.95rem] m-0">
                        {entry.data.caseTitle}
                      </h2>
                      <span
                        class={entry.data.status === 'confirmed' ? 'status-badge confirmed' : 'status-badge draft'}
                      >
                        {entry.data.status}
                      </span>
                    </div>
                    <div class="text-xs text-text-muted">
                      <span>
                        OS: {entry.data.os}
                        {entry.data.osVersion && ` ${entry.data.osVersion}`}
                      </span>
                      {' · '}
                      <span>
                        Device: {entry.data.device}
                        {entry.data.deviceVersion && ` ${entry.data.deviceVersion}`}
                      </span>
                      {' · '}
                      <span>
                        Browser: {entry.data.browser}
                        {entry.data.browserVersion && ` ${entry.data.browserVersion}`}
                      </span>
                      {' · '}
                      <span>Keyboard: {entry.data.keyboard}</span>
                      {' · '}
                      <span>
                        Scenario:{' '}
                        <a
                          href={`/scenarios/${encodeURIComponent(entry.data.scenarioId)}`}
                          class="text-inherit underline"
                          onclick={`event.stopPropagation(); window.location.href='/scenarios/${encodeURIComponent(entry.data.scenarioId)}'`}
                        >
                          {entry.data.scenarioId}
                        </a>
                      </span>
                    </div>
                  </header>

                  {entry.data.tags.length > 0 && (
                    <div class="text-xs text-text-secondary">
                      {entry.data.tags.map((tag) => (
                        <a
                          href={`?locale=${encodeURIComponent(
                            locale,
                          )}&status=${encodeURIComponent(
                            statusFilter,
                          )}&tag=${encodeURIComponent(tag)}&q=${encodeURIComponent(
                            searchParams.get('q') ?? '',
                          )}`}
                          class="inline-flex items-center rounded-full border border-border-light px-1.5 py-0.5 mr-1 no-underline text-inherit"
                          onclick={`event.stopPropagation(); window.location.href='?locale=${encodeURIComponent(
                            locale,
                          )}&status=${encodeURIComponent(
                            statusFilter,
                          )}&tag=${encodeURIComponent(tag)}&q=${encodeURIComponent(
                            searchParams.get('q') ?? '',
                          )}'`}
                        >
                          {tag}
                        </a>
                      ))}
                    </div>
                  )}

                  <footer class="mt-1.5 flex gap-2.5">
                    <a
                      href={`/cases/${entry.slug}`}
                      class="inline-flex items-center gap-0.5 text-xs text-text-primary no-underline font-medium"
                      onclick={`event.stopPropagation(); window.location.href='/cases/${entry.slug}'`}
                    >
                      <span>View details</span>
                      <span aria-hidden="true">→</span>
                    </a>
                    <a
                      href={`/?scenario=${encodeURIComponent(entry.data.id)}`}
                      class="inline-flex items-center gap-0.5 text-xs text-text-secondary no-underline"
                      onclick={`event.stopPropagation(); window.location.href='/?scenario=${encodeURIComponent(entry.data.id)}'`}
                    >
                      <span>Open in playground</span>
                      <span aria-hidden="true">↗</span>
                    </a>
                  </footer>
                </article>
              ))}
            </div>
          );
        })()}
      </section>
    </main>
  </body>
</html>

<style>
  .status-badge {
    font-size: 0.7rem;
    padding: 0.1rem 0.45rem;
    border-radius: 999px;
    border: 1px solid var(--border-medium);
  }

  .status-badge.confirmed {
    background: var(--status-confirmed-light);
    color: var(--status-confirmed);
  }

  .status-badge.draft {
    background: var(--status-draft-light);
    color: var(--status-draft);
  }
</style>

