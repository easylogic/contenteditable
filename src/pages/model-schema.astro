---
import SiteNav from '../components/SiteNav.astro';
import BaseHead from '../components/BaseHead.astro';
import TableOfContents from '../components/TableOfContents.astro';
import DocCodeBlock from '../components/docs/DocCodeBlock.astro';
import DocSection from '../components/docs/DocSection.astro';
import '../styles/global.css';

const headings = [
  { depth: 2, slug: 'overview', text: 'Overview' },
  { depth: 2, slug: 'model-schema-relationship', text: 'Model & Schema Relationship' },
  { depth: 2, slug: 'data-transformation', text: 'Data Transformation' },
  { depth: 2, slug: 'view-integration', text: 'View Integration' },
  { depth: 2, slug: 'schema-migration', text: 'Schema Migration' },
  { depth: 3, slug: 'version-management', text: 'Version Management' },
  { depth: 3, slug: 'migration-strategies', text: 'Migration Strategies' },
  { depth: 3, slug: 'backward-compatibility', text: 'Backward Compatibility' },
  { depth: 2, slug: 'collaborative-editing', text: 'Collaborative Editing' },
  { depth: 3, slug: 'operational-transformation', text: 'Operational Transformation' },
  { depth: 3, slug: 'crdt-implementation', text: 'CRDT Implementation' },
  { depth: 3, slug: 'conflict-resolution', text: 'Conflict Resolution' },
  { depth: 2, slug: 'indexing-strategies', text: 'Indexing Strategies' },
  { depth: 3, slug: 'document-index', text: 'Document Index' },
  { depth: 3, slug: 'position-index', text: 'Position Index' },
  { depth: 3, slug: 'content-index', text: 'Content Index' },
  { depth: 2, slug: 'validation-algorithms', text: 'Advanced Validation' },
  { depth: 3, slug: 'recursive-validation', text: 'Recursive Validation' },
  { depth: 3, slug: 'circular-reference', text: 'Circular Reference Handling' },
  { depth: 3, slug: 'performance-validation', text: 'Performance Optimization' },
  { depth: 2, slug: 'transaction-system', text: 'Transaction System' },
  { depth: 3, slug: 'transaction-model', text: 'Transaction Model' },
  { depth: 3, slug: 'rollback-mechanism', text: 'Rollback Mechanism' },
  { depth: 2, slug: 'node-types', text: 'Node Types' },
];
---

<html lang="en">
  <head>
    <BaseHead
      title="Model & Schema – contenteditable.lab"
      description="Understanding the relationship between Model and Schema, data transformation, view integration, collaborative editing, and comprehensive node type examples"
    />
  </head>
  <body>
    <SiteNav />
    <main class="flex max-w-full m-0 p-0">
      <section class="flex-1 flex max-w-[1120px] mx-auto py-7 px-5 pb-10 gap-6 w-full">
        <div class="flex-1">
          <header class="mb-8">
            <nav class="mb-4 text-sm">
              <a href="/" class="text-text-muted no-underline">Home</a>
              <span class="text-text-faint mx-2">/</span>
              <span class="text-text-primary">Model/Schema</span>
            </nav>
            <h1 class="text-3xl leading-tight m-0 mb-2">
              Model & Schema
            </h1>
            <p class="m-0 text-[0.95rem] text-text-secondary">
              Deep dive into the relationship between Model and Schema, data transformation, view integration, collaborative editing, and comprehensive node type examples from basic to complex custom schemas.
            </p>
          </header>

          <article class="rounded-xl border border-border-light bg-bg-surface p-6 px-7 text-[0.9rem] leading-[1.7]">
            <DocSection id="overview" title="Overview">
              <p class="m-0 mb-4">
                The Model represents the actual document data, while the Schema defines what structures are valid. Understanding their relationship is crucial for building robust editors that can transform data, integrate with views, and support collaborative editing.
              </p>
              <p class="m-0 mb-4">
                This guide covers the fundamental concepts and provides 50+ node type examples ranging from basic text nodes to complex custom schemas like cards, tables, and interactive components.
              </p>
            </DocSection>

            <DocSection id="model-schema-relationship" title="Model & Schema Relationship">
              <p class="m-0 mb-4">
                The <strong>Schema</strong> is the contract that defines what your document can contain. It specifies:
              </p>
              <ul class="m-0 mb-4 pl-6">
                <li>What node types exist</li>
                <li>What attributes each node can have</li>
                <li>What content each node can contain</li>
                <li>What marks can be applied</li>
                <li>Validation rules and constraints</li>
              </ul>
              <p class="m-0 mb-4">
                The <strong>Model</strong> is an instance of a document that conforms to the schema. It's the actual data structure representing the current state of the document.
              </p>
              <DocCodeBlock code={`// Schema defines the rules
const schema = {
  nodes: {
    paragraph: {
      content: 'inline*',
      group: 'block'
    },
    heading: {
      content: 'inline*',
      group: 'block',
      attrs: {
        level: { default: 1 }
      }
    }
  }
};

// Model is an instance conforming to the schema
const model = {
  type: 'document',
  children: [
    {
      type: 'heading',
      attrs: { level: 1 },
      children: [
        { type: 'text', text: 'Hello World' }
      ]
    },
    {
      type: 'paragraph',
      children: [
        { type: 'text', text: 'This is a paragraph.' }
      ]
    }
  ]
};`} />
            </DocSection>

            <DocSection id="data-transformation" title="Data Transformation">
              <p class="m-0 mb-4">
                Data transformation is the process of converting between different representations of your document:
              </p>
              <ul class="m-0 mb-4 pl-6">
                <li><strong>Serialization</strong>: Model → JSON, HTML, Markdown, etc.</li>
                <li><strong>Deserialization</strong>: JSON, HTML, Markdown → Model</li>
                <li><strong>Migration</strong>: Updating model structure when schema changes</li>
                <li><strong>Normalization</strong>: Ensuring model conforms to schema</li>
              </ul>
              <DocCodeBlock code={`// Serialize model to JSON
function serializeToJSON(model) {
  return JSON.stringify(model, null, 2);
}

// Deserialize JSON to model
function deserializeFromJSON(json) {
  const data = JSON.parse(json);
  return normalizeModel(data); // Ensure it conforms to schema
}

// Normalize model to ensure schema compliance
function normalizeModel(model) {
  // Validate structure
  // Fix invalid nesting
  // Add missing required attributes
  // Remove invalid attributes
  return validatedModel;
}

// Migrate old model to new schema version
function migrateModel(oldModel, oldSchema, newSchema) {
  // Transform nodes that changed
  // Update attributes
  // Handle removed node types
  return migratedModel;
}`} />
            </DocSection>

            <DocSection id="view-integration" title="View Integration">
              <p class="m-0 mb-4">
                The view layer renders the model and handles user interactions. Integration requires:
              </p>
              <ul class="m-0 mb-4 pl-6">
                <li><strong>Rendering</strong>: Converting model to DOM</li>
                <li><strong>Input Handling</strong>: Converting DOM changes back to model updates</li>
                <li><strong>Selection Mapping</strong>: Converting between DOM selection and model positions</li>
                <li><strong>Change Detection</strong>: Detecting when model changes and updating view</li>
              </ul>
              <DocCodeBlock code={`// Render model to DOM
function renderModel(model, container) {
  container.innerHTML = '';
  model.children.forEach(child => {
    const element = renderNode(child);
    container.appendChild(element);
  });
}

function renderNode(node) {
  switch (node.type) {
    case 'paragraph':
      const p = document.createElement('p');
      node.children.forEach(child => {
        p.appendChild(renderNode(child));
      });
      return p;
    case 'text':
      const text = document.createTextNode(node.text);
      // Apply marks
      if (node.marks && node.marks.length > 0) {
        return wrapWithMarks(text, node.marks);
      }
      return text;
    // ... other node types
  }
}

// Handle DOM changes and update model
function handleInput(domElement, model) {
  // Convert DOM changes to model operations
  const operations = diffDOMToModel(domElement, model);
  operations.forEach(op => {
    applyOperation(model, op);
  });
  return model;
}

// Map DOM selection to model position
function getModelPosition(domSelection) {
  const range = domSelection.getRangeAt(0);
  const path = getPathFromDOMNode(range.startContainer);
  return {
    path: path,
    offset: range.startOffset
  };
}`} />
            </DocSection>

            <DocSection id="schema-migration" title="Schema Migration">
              <p class="m-0 mb-4">
                As your editor evolves, the schema may change. Migrating existing documents to new schemas requires careful planning and implementation.
              </p>
              <p class="m-0 mb-4">
                <a href="/model-schema/migration" class="text-accent-primary hover:underline font-semibold">
                  Read detailed guide on Schema Migration →
                </a>
              </p>
            </DocSection>


            <DocSection id="collaborative-editing" title="Collaborative Editing">
              <p class="m-0 mb-4">
                Collaborative editing requires transforming operations to handle concurrent edits. Two main approaches are Operational Transformation (OT) and CRDTs.
              </p>
              <p class="m-0 mb-4">
                <a href="/model-schema/collaborative-editing" class="text-accent-primary hover:underline font-semibold">
                  Read detailed guide on Collaborative Editing →
                </a>
              </p>
            </DocSection>

            <DocSection id="indexing-strategies" title="Indexing Strategies">
              <p class="m-0 mb-4">
                Efficient indexing is crucial for performance with large documents. Multiple indexing strategies can be used together.
              </p>
              <p class="m-0 mb-4">
                <a href="/model-schema/indexing" class="text-accent-primary hover:underline font-semibold">
                  Read detailed guide on Indexing Strategies →
                </a>
              </p>
            </DocSection>

            <DocSection id="validation-algorithms" title="Advanced Validation">
              <p class="m-0 mb-4">
                Complex validation algorithms ensure document integrity while maintaining performance.
              </p>
              <p class="m-0 mb-4">
                <a href="/model-schema/validation" class="text-accent-primary hover:underline font-semibold">
                  Read detailed guide on Advanced Validation →
                </a>
              </p>
            </DocSection>

            <DocSection id="transaction-system" title="Transaction System">
              <p class="m-0 mb-4">
                A transaction system ensures atomic operations and provides rollback capabilities.
              </p>
              <p class="m-0 mb-4">
                <a href="/model-schema/transaction" class="text-accent-primary hover:underline font-semibold">
                  Read detailed guide on Transaction System →
                </a>
              </p>
            </DocSection>

            <DocSection id="node-types" title="Node Types">
              <p class="m-0 mb-4">
                Comprehensive guide to 52+ node types with detailed implementation examples, view integration notes, and common pitfalls. Each node type has its own detailed page covering schema, model representation, HTML mapping, view integration, and common issues.
              </p>
              <p class="m-0 mb-4">
                <a href="/model-schema/node-types" class="text-accent-primary hover:underline font-semibold">
                  Browse all node types →
                </a>
              </p>
            </DocSection>
          </article>
        </div>
        <TableOfContents headings={headings} />
      </section>
    </main>
  </body>
</html>
