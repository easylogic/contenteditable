---
import { getCollection } from 'astro:content';
import SiteNav from '../components/SiteNav.astro';
import BaseHead from '../components/BaseHead.astro';
import '../styles/global.css';

const allCases = await getCollection('cases', ({ data }) => data.locale === 'en');
const allScenarios = await getCollection('scenarios', ({ data }) => data.locale === 'en');

// Create a map of scenarioId -> scenario entry
const scenarioEntriesMap = new Map(
  allScenarios.map((s) => [s.data.id, s])
);

// Group cases by scenarioId and enrich with scenario metadata
const scenariosMap = allCases.reduce(
  (acc, entry) => {
    const key = entry.data.scenarioId;
    if (!acc[key]) {
      const scenarioEntry = scenarioEntriesMap.get(key);
      acc[key] = {
        scenarioId: key,
        scenarioEntry: scenarioEntry || null,
        cases: [] as typeof allCases,
      };
    }
    acc[key].cases.push(entry);
    return acc;
  },
  {} as Record<
    string,
    {
      scenarioId: string;
      scenarioEntry: (typeof allScenarios)[0] | null;
      cases: typeof allCases;
    }
  >,
);

const scenarios = Object.values(scenariosMap).sort((a, b) =>
  a.scenarioId.localeCompare(b.scenarioId),
);

// Group scenarios by category (from scenario metadata or fallback to tags)
const scenariosByCategory = scenarios.reduce(
  (acc, scenario) => {
    // Use category from scenario metadata, or infer from tags
    let category = scenario.scenarioEntry?.data.category || 'other';
    
    if (category === 'other') {
      // Fallback: infer from case tags
      const tags = scenario.cases.flatMap((c) => c.data.tags);
      const categoryTags = [
        'ime',
        'composition',
        'formatting',
        'paste',
        'selection',
        'caret',
        'mobile',
        'accessibility',
        'performance',
        'focus',
      ];

      for (const catTag of categoryTags) {
        if (tags.includes(catTag)) {
          category = catTag;
          break;
        }
      }
    }

    if (!acc[category]) acc[category] = [];
    acc[category].push(scenario);
    return acc;
  },
  {} as Record<string, typeof scenarios>,
);

const categoryLabels: Record<string, string> = {
  ime: 'IME & Composition',
  composition: 'IME & Composition',
  formatting: 'Formatting',
  paste: 'Paste & Copy',
  selection: 'Selection',
  caret: 'Caret & Navigation',
  mobile: 'Mobile & Touch',
  accessibility: 'Accessibility',
  performance: 'Performance',
  focus: 'Focus & Blur',
  other: 'Other',
};
---

<html lang="en">
  <head>
    <BaseHead title="contenteditable scenarios" description="Scenarios grouping cases by phenomenon across environments." />
  </head>
  <body>
    <SiteNav />
    <main class="max-w-[1120px] mx-auto py-7 px-5 pb-10">
      <header class="mb-6">
        <h1 class="text-[2rem] leading-[1.1] m-0 mb-2">
          Scenarios
        </h1>
        <p class="m-0 mb-3 text-[0.95rem] text-text-secondary">
          A scenario groups multiple cases that describe the same phenomenon across different
          operating systems, devices, browsers, or keyboard setups.
        </p>
        <div class="flex gap-4 text-sm text-text-muted">
          <span>
            <strong class="text-text-primary">{scenarios.length}</strong> scenarios
          </span>
          <span>
            <strong class="text-text-primary">{allCases.length}</strong> total cases
          </span>
        </div>
      </header>

      <section class="rounded-xl border border-border-light bg-bg-surface p-3.5 px-4">
        {scenarios.length === 0 ? (
          <p class="text-sm text-text-muted">
            No scenarios have been defined yet. Add cases with a scenarioId in the content
            directory.
          </p>
        ) : (
          <div>
            {Object.entries(scenariosByCategory)
              .sort(([a], [b]) => {
                const order = [
                  'ime',
                  'composition',
                  'formatting',
                  'paste',
                  'selection',
                  'caret',
                  'mobile',
                  'accessibility',
                  'performance',
                  'focus',
                  'other',
                ];
                const aIdx = order.indexOf(a);
                const bIdx = order.indexOf(b);
                if (aIdx === -1 && bIdx === -1) return a.localeCompare(b);
                if (aIdx === -1) return 1;
                if (bIdx === -1) return -1;
                return aIdx - bIdx;
              })
              .map(([category, categoryScenarios]) => (
                <div class="mb-8">
                  <h2 class="text-base font-semibold m-0 mb-3 text-text-primary capitalize">
                    {categoryLabels[category] || category}
                  </h2>
                  <div class="grid grid-cols-[repeat(auto-fit,minmax(260px,1fr))] gap-3.5 mb-6">
                    {categoryScenarios.map((scenario) => {
                      const osSet = new Set(scenario.cases.map((c) => c.data.os));
                      const browserSet = new Set(scenario.cases.map((c) => c.data.browser));
                      const title = scenario.scenarioEntry?.data.title || scenario.cases[0]?.data.caseTitle || scenario.scenarioId;
                      const description = scenario.scenarioEntry?.data.description || scenario.cases[0]?.data.caseTitle;
                      return (
                        <a
                          href={`/scenarios/${encodeURIComponent(scenario.scenarioId)}`}
                          class="block rounded-xl border border-border-light p-3.5 px-3.5 text-sm no-underline text-inherit hover:border-accent-primary hover:bg-bg-muted transition-colors cursor-pointer"
                        >
                          <h2 class="text-sm m-0 mb-1.5 text-text-primary">
                            {title}
                          </h2>
                          <div class="flex gap-1.5 flex-wrap m-0 mb-1.5">
                            <span class="text-xs px-1.5 py-0.5 rounded-full border border-border-light bg-bg-muted text-text-secondary">
                              {scenario.cases.length} variant{scenario.cases.length === 1 ? '' : 's'}
                            </span>
                            {Array.from(osSet)
                              .slice(0, 3)
                              .map((os) => (
                                <span
                                  class="text-xs px-1.5 py-0.5 rounded-full border border-border-light bg-bg-surface text-text-muted"
                                >
                                  {os}
                                </span>
                              ))}
                            {Array.from(browserSet)
                              .slice(0, 2)
                              .map((browser) => (
                                <span
                                  class="text-xs px-1.5 py-0.5 rounded-full border border-border-light bg-bg-surface text-text-muted"
                                >
                                  {browser}
                                </span>
                              ))}
                          </div>
                          <p class="m-0 mb-1.5 text-text-secondary text-xs">
                            {description}
                          </p>
                          <div class="text-xs text-text-primary font-medium mt-2">
                            Open scenario â†’
                          </div>
                        </a>
                      );
                    })}
                  </div>
                </div>
              ))}
          </div>
        )}
      </section>
    </main>
  </body>
</html>


