---
import { getCollection } from 'astro:content';
import SiteNav from '../components/SiteNav.astro';
import BaseHead from '../components/BaseHead.astro';
import GraphVisualizationSigma from '../components/GraphVisualizationSigma';
import '../styles/global.css';

const allCases = await getCollection('cases');
const allScenarios = await getCollection('scenarios');

// Build graph data
const nodes: Array<{
  id: string;
  label: string;
  type: 'case' | 'scenario' | 'tag' | 'category' | 'os' | 'browser' | 'device' | 'keyboard';
  color: string;
  size: number;
  url?: string;
  status?: 'draft' | 'confirmed';
  metadata?: Record<string, any>;
}> = [];

const edges: Array<{
  from: string;
  to: string;
  type: 'scenario' | 'tag' | 'category' | 'os' | 'browser' | 'device' | 'keyboard' | 'case-relation' | 'scenario-relation';
  width: number;
  color: string;
}> = [];

// Color scheme
const colors = {
  case: '#ef4444', // red
  caseDraft: '#fca5a5', // light red
  scenario: '#3b82f6', // blue
  scenarioDraft: '#93c5fd', // light blue
  tag: '#f59e0b', // amber
  category: '#10b981', // green
  os: '#8b5cf6', // purple
  browser: '#06b6d4', // cyan
  device: '#f97316', // orange
  keyboard: '#ec4899', // pink
  edgeScenario: '#3b82f6',
  edgeTag: '#f59e0b',
  edgeCategory: '#10b981',
  edgeOs: '#8b5cf6',
  edgeBrowser: '#06b6d4',
  edgeDevice: '#f97316',
  edgeKeyboard: '#ec4899',
  edgeCaseRelation: '#94a3b8', // gray for case-to-case
  edgeScenarioRelation: '#60a5fa', // light blue for scenario-to-scenario
};

// Add scenario nodes
allScenarios.forEach((scenario) => {
  const caseCount = allCases.filter((c) => c.data.scenarioId === scenario.data.id).length;
  nodes.push({
    id: `scenario-${scenario.data.id}`,
    label: scenario.data.title || scenario.data.id,
    type: 'scenario',
    color: scenario.data.status === 'confirmed' ? colors.scenario : colors.scenarioDraft,
    size: Math.max(20, Math.min(50, 20 + caseCount * 2)),
    url: `/scenarios/${encodeURIComponent(scenario.data.id)}`,
    status: scenario.data.status,
    metadata: {
      category: scenario.data.category,
      tags: scenario.data.tags,
      description: scenario.data.description,
    },
  });
});

// Add case nodes
allCases.forEach((case_) => {
  nodes.push({
    id: `case-${case_.data.id}`,
    label: case_.data.caseTitle || case_.data.id,
    type: 'case',
    color: case_.data.status === 'confirmed' ? colors.case : colors.caseDraft,
    size: 15,
    url: `/cases/${case_.slug}`,
    status: case_.data.status,
    metadata: {
      os: case_.data.os,
      browser: case_.data.browser,
      device: case_.data.device,
      keyboard: case_.data.keyboard,
      tags: case_.data.tags,
      scenarioId: case_.data.scenarioId,
    },
  });

  // Add case -> scenario edge
  edges.push({
    from: `case-${case_.data.id}`,
    to: `scenario-${case_.data.scenarioId}`,
    type: 'scenario',
    width: 3,
    color: colors.edgeScenario,
  });
});

// Group cases by scenario to add case-to-case edges
const casesByScenario = new Map<string, typeof allCases>();
allCases.forEach((case_) => {
  const scenarioId = case_.data.scenarioId;
  if (!casesByScenario.has(scenarioId)) {
    casesByScenario.set(scenarioId, []);
  }
  casesByScenario.get(scenarioId)!.push(case_);
});

// Add case-to-case edges for cases in the same scenario
casesByScenario.forEach((cases, scenarioId) => {
  if (cases.length > 1) {
    // Connect all cases in the same scenario (star pattern: all connect to first case)
    const firstCaseId = `case-${cases[0].data.id}`;
    for (let i = 1; i < cases.length; i++) {
      edges.push({
        from: firstCaseId,
        to: `case-${cases[i].data.id}`,
        type: 'case-relation',
        width: 1.5,
        color: colors.edgeCaseRelation,
      });
    }
  }
});

// Calculate node degrees for layout positioning
const nodeDegrees = new Map<string, number>();
edges.forEach((edge) => {
  nodeDegrees.set(edge.from, (nodeDegrees.get(edge.from) || 0) + 1);
  nodeDegrees.set(edge.to, (nodeDegrees.get(edge.to) || 0) + 1);
});

// Calculate layout positions: cases on left, scenarios on right
// Cases with more connections get positioned higher
const caseNodes = nodes.filter((n) => n.type === 'case');
const scenarioNodes = nodes.filter((n) => n.type === 'scenario');

// Sort by degree (connections) for better layout
caseNodes.sort((a, b) => (nodeDegrees.get(b.id) || 0) - (nodeDegrees.get(a.id) || 0));
scenarioNodes.sort((a, b) => (nodeDegrees.get(b.id) || 0) - (nodeDegrees.get(a.id) || 0));

const graphData = {
  nodes: [
    ...caseNodes.map((n, i) => ({
      id: n.id,
      label: n.label,
      color: n.color,
      size: n.size,
      shape: 'circle' as const,
      url: n.url,
      status: n.status,
      nodeType: n.type,
      metadata: n.metadata,
      // Hierarchical layout: cases on left
      x: -500 + (i % 10) * 100,
      y: -400 + Math.floor(i / 10) * 80,
    })),
    ...scenarioNodes.map((n, i) => ({
      id: n.id,
      label: n.label,
      color: n.color,
      size: n.size,
      shape: 'diamond' as const,
      url: n.url,
      status: n.status,
      nodeType: n.type,
      metadata: n.metadata,
      // Hierarchical layout: scenarios on right, arranged in a grid
      x: 600 + (i % 12) * 100,
      y: -500 + Math.floor(i / 12) * 100,
    })),
  ],
  edges: edges.map((e) => ({
    from: e.from,
    to: e.to,
    color: e.color,
    size: e.width, // sigma.js uses 'size' for edge width
    edgeType: e.type, // Renamed from 'type' to avoid conflict with sigma.js
  })),
};

const stats = {
  totalCases: allCases.length,
  totalScenarios: allScenarios.length,
  confirmedCases: allCases.filter((c) => c.data.status === 'confirmed').length,
  confirmedScenarios: allScenarios.filter((s) => s.data.status === 'confirmed').length,
};
---

<html lang="en">
  <head>
    <BaseHead title="Relationship Graph – contenteditable" description="Interactive graph visualization of cases, scenarios, tags, and their relationships." />
  </head>
  <body>
    <SiteNav />
    <main class="max-w-[1400px] mx-auto py-7 px-5 pb-10">
      <header class="mb-6">
        <h1 class="text-[2rem] leading-[1.1] m-0 mb-2">
          Relationship Graph
        </h1>
        <p class="m-0 mb-3 text-[0.95rem] text-text-secondary">
          Interactive visualization of cases, scenarios, tags, and categories. Click on nodes to navigate, drag to explore, and use filters to focus on specific relationships.
        </p>
        <div class="flex gap-4 text-sm text-text-muted flex-wrap">
          <span>
            <strong class="text-text-primary">{stats.totalCases}</strong> cases
          </span>
          <span>
            <strong class="text-text-primary">{stats.totalScenarios}</strong> scenarios
          </span>
          <span>
            <strong class="text-text-primary">{stats.totalTags}</strong> tags
          </span>
          <span>
            <strong class="text-text-primary">{graphData.edges.length}</strong> connections
          </span>
        </div>
      </header>

      <section class="rounded-xl border border-border-light bg-bg-surface p-4 mb-6">
        <GraphVisualizationSigma client:load nodes={graphData.nodes} edges={graphData.edges} />
      </section>

      <section class="rounded-xl border border-border-light bg-bg-surface p-4">
        <h2 class="text-lg m-0 mb-3">Legend</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
          <div>
            <div class="font-semibold mb-2">Node Types</div>
            <div class="flex flex-col gap-1.5">
              <div class="flex items-center gap-2">
                <span class="inline-block w-4 h-4 rounded-full" style="background: {colors.case}"></span>
                <span>Case (confirmed)</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="inline-block w-4 h-4 rounded-full" style="background: {colors.caseDraft}"></span>
                <span>Case (draft)</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="inline-block w-4 h-4" style="background: {colors.scenario}; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);"></span>
                <span>Scenario</span>
              </div>
            </div>
          </div>
          <div>
            <div class="font-semibold mb-2">Edge Types</div>
            <div class="flex flex-col gap-1.5">
              <div class="flex items-center gap-2">
                <span class="inline-block w-6 h-0.5" style="background: {colors.edgeScenario}"></span>
                <span>Case → Scenario</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="inline-block w-6 h-0.5" style="background: {colors.edgeCaseRelation}"></span>
                <span>Case → Case (same scenario)</span>
              </div>
            </div>
          </div>
          <div>
            <div class="font-semibold mb-2">Interactions</div>
            <div class="flex flex-col gap-1.5 text-text-secondary">
              <div>• Click node to navigate</div>
              <div>• Drag to move nodes</div>
              <div>• Scroll to zoom</div>
              <div>• Drag background to pan</div>
            </div>
          </div>
          <div>
            <div class="font-semibold mb-2">Tips</div>
            <div class="flex flex-col gap-1.5 text-text-secondary">
              <div>• Use filters to focus</div>
              <div>• Larger nodes = more connections</div>
              <div>• Thicker edges = stronger relationships</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </body>
</html>

